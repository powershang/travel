<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="ä½è³€æ—…è¡Œ">
<meta name="theme-color" content="#e91e63">
<title>2026 ä½è³€æ—…è¡Œ</title>
<link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxODAgMTgwIj48cmVjdCB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgcng9IjQwIiBmaWxsPSIjZTkxZTYzIi8+PHRleHQgeD0iOTAiIHk9IjEwNSIgZm9udC1zaXplPSI4MCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0id2hpdGUiPuS9kOizgDwvdGV4dD48dGV4dCB4PSI5MCIgeT0iMTQ1IiBmb250LXNpemU9IjMwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSIjZmZjY2JjIj7ml4XooYwgMjAyNjwvdGV4dD48L3N2Zz4=">
<style>
:root {
  --pink: #e91e63;
  --pink-light: #fce4ec;
  --pink-dark: #c2185b;
  --bg: #f5f5f5;
  --card: #fff;
  --text: #212121;
  --text2: #757575;
  --safe-top: env(safe-area-inset-top, 0px);
  --safe-bottom: env(safe-area-inset-bottom, 0px);
  --tab-h: 56px;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:var(--bg);color:var(--text);overflow:hidden;height:100vh;height:100dvh;position:fixed;width:100%}

.header{background:linear-gradient(135deg,var(--pink),var(--pink-dark));color:#fff;padding:calc(var(--safe-top)+12px) 16px 6px;display:flex;align-items:center;justify-content:space-between;z-index:100;position:relative}
@media all and (display-mode:standalone){.header{padding-top:calc(env(safe-area-inset-top,28px) + 12px)}}
.header h1{font-size:17px;font-weight:600}
.header .subtitle{font-size:11px;opacity:.85}
.header-btns{display:flex;gap:6px;align-items:center}
.header-btn{background:rgba(255,255,255,.2);border:none;color:#fff;width:34px;height:34px;border-radius:50%;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.header-btn:active{background:rgba(255,255,255,.4)}
.header-btn.edit-active{background:#fff;color:var(--pink-dark)}
.day-chips{display:flex;gap:4px;overflow-x:auto;padding:4px 16px 10px;background:linear-gradient(135deg,var(--pink),var(--pink-dark));-webkit-overflow-scrolling:touch}
.day-chip{flex-shrink:0;padding:7px 14px;border-radius:20px;font-size:12px;font-weight:500;background:rgba(255,255,255,.2);color:#fff;border:none;cursor:pointer;white-space:nowrap;transition:.2s}
.day-chip.active{background:#fff;color:var(--pink-dark);font-weight:600}

.tab-bar{position:fixed;bottom:0;left:0;right:0;height:calc(var(--tab-h)+var(--safe-bottom));padding-bottom:var(--safe-bottom);background:#fff;display:flex;border-top:1px solid #e0e0e0;z-index:100}
.tab-item{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;font-size:10px;color:var(--text2);border:none;background:none;cursor:pointer;padding:4px 0;transition:.2s}
.tab-item.active{color:var(--pink)}
.tab-item .icon{font-size:22px}

.content{position:fixed;top:0;left:0;right:0;height:calc(100dvh - var(--tab-h) - var(--safe-bottom));overflow:hidden}
.page{display:none;height:100%}
.page.active{display:flex;flex-direction:column;overflow:hidden}
.page-scroll{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:8px 12px 20px;min-height:0}

#itinerary-page .itin-body{flex:1;display:flex;flex-direction:row;overflow:hidden}
#cards-panel{width:45%;min-width:180px;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:8px 10px 20px;border-right:1px solid #e0e0e0;background:var(--bg)}
#map-panel{flex:1;position:relative}
#map-container{width:100%;height:100%}

#food-page .food-body{flex:1;display:flex;flex-direction:row;overflow:hidden}
#food-cards-panel{width:45%;min-width:180px;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:8px 10px 20px;border-right:1px solid #e0e0e0;background:var(--bg)}
#food-map-panel{flex:1;position:relative}
#food-map-container{width:100%;height:100%}

@media(max-width:540px) and (orientation:portrait){
  #itinerary-page .itin-body{flex-direction:column}
  #cards-panel{width:100%;order:2;flex:1;border-right:none;border-top:2px solid var(--pink-light)}
  #map-panel{order:1;height:35vh;flex:none}
  #food-page .food-body{flex-direction:column}
  #food-cards-panel{width:100%;order:2;flex:1;border-right:none;border-top:2px solid var(--pink-light)}
  #food-map-panel{order:1;height:35vh;flex:none}
}

.now-indicator{background:var(--pink-light);border-left:3px solid var(--pink);padding:7px 10px;margin-bottom:8px;border-radius:8px;font-size:12px;font-weight:500;color:var(--pink-dark)}
.countdown-bar{background:linear-gradient(135deg,#fff3e0,#ffe0b2);padding:7px 10px;border-radius:8px;font-size:12px;display:flex;align-items:center;gap:6px;margin-bottom:8px}

.card{background:var(--card);border-radius:12px;margin-bottom:10px;box-shadow:0 1px 3px rgba(0,0,0,.07);overflow:hidden;transition:box-shadow .25s}
.card.now{box-shadow:0 0 0 2px var(--pink),0 2px 8px rgba(233,30,99,.2)}
.card.highlight{box-shadow:0 0 0 2px #2196f3,0 2px 8px rgba(33,150,243,.3)}
.card.dragging{opacity:.4}
.card-main{display:flex;align-items:center;padding:10px;gap:8px;cursor:pointer}
.card-time{font-size:12px;font-weight:600;color:var(--pink-dark);min-width:40px;text-align:center}
.card-icon{width:34px;height:34px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:17px;flex-shrink:0}
.card-icon.spot{background:#e8f5e9}.card-icon.restaurant{background:#fff3e0}.card-icon.hotel{background:#fce4ec}.card-icon.transport{background:#e3f2fd}.card-icon.snack{background:#fff8e1}.card-icon.airport{background:#eceff1}
.card-info{flex:1;min-width:0}
.card-name{font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.card-sub{font-size:11px;color:var(--text2);margin-top:1px}
.card-drag-handle{cursor:grab;color:#bbb;font-size:16px;flex-shrink:0;padding:0 2px;user-select:none;touch-action:none}
.card-drag-handle:active{cursor:grabbing;color:#999}
.card.drag-over{border-top:2.5px solid var(--pink)}
.card-arrow{color:#ccc;font-size:14px;flex-shrink:0}
.card-detail{display:none;padding:0 10px 10px;border-top:1px solid #f0f0f0}
.card-detail.open{display:block}
.card-actions{display:flex;gap:6px;padding-top:6px;flex-wrap:wrap}
.btn{display:inline-flex;align-items:center;gap:4px;padding:6px 10px;border-radius:16px;font-size:11px;font-weight:500;border:none;cursor:pointer;text-decoration:none;white-space:nowrap}
.btn-nav{background:#e3f2fd;color:#1565c0}.btn-call{background:#e8f5e9;color:#2e7d32}.btn-link{background:#fff3e0;color:#e65100}
.btn-del{background:#ffebee;color:#c62828}.btn-edit{background:#e8eaf6;color:#283593}
.btn:active{opacity:.7}
.drive-info{display:flex;align-items:center;gap:4px;padding:2px 10px 2px 58px;font-size:10px;color:var(--text2)}
.drive-info::before{content:'';width:1px;height:10px;background:#ddd}
.section-title{font-size:12px;font-weight:600;color:var(--text2);padding:6px 0 4px}

/* Edit mode card extras */
.edit-bar{display:none;align-items:center;gap:4px;padding:4px 10px;background:#f5f5f5;border-top:1px solid #eee}
.edit-mode .edit-bar{display:flex}
.edit-bar .drag-handle{cursor:grab;font-size:16px;color:#999;margin-right:auto}
.add-item-btn{display:none;width:100%;padding:12px;border:2px dashed #ccc;border-radius:12px;background:none;font-size:13px;color:var(--text2);cursor:pointer;margin:8px 0}
.edit-mode .add-item-btn{display:block}
.add-item-btn:active{background:#f0f0f0}

/* Modal / Panel overlay */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:200;justify-content:center;align-items:flex-end}
.modal-overlay.open{display:flex}
.modal-panel{background:#fff;border-radius:16px 16px 0 0;width:100%;max-width:480px;max-height:85vh;overflow-y:auto;padding:20px 16px calc(var(--safe-bottom) + 16px);animation:slideUp .25s ease}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
.modal-header h2{font-size:16px}
.modal-close{background:none;border:none;font-size:22px;cursor:pointer;color:var(--text2);width:36px;height:36px;display:flex;align-items:center;justify-content:center;border-radius:50%}
.modal-close:active{background:#f0f0f0}

/* Plan list */
.plan-item{display:flex;align-items:center;gap:10px;padding:12px;border-radius:10px;margin-bottom:6px;cursor:pointer;border:1.5px solid #eee;transition:.2s}
.plan-item:active{background:#f5f5f5}
.plan-item.active-plan{border-color:var(--pink);background:var(--pink-light)}
.plan-radio{width:18px;height:18px;border-radius:50%;border:2px solid #ccc;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.plan-item.active-plan .plan-radio{border-color:var(--pink);background:var(--pink)}
.plan-item.active-plan .plan-radio::after{content:'';width:8px;height:8px;border-radius:50%;background:#fff}
.plan-name{flex:1;font-size:14px;font-weight:500}
.plan-actions{display:flex;gap:2px}
.plan-actions button{background:none;border:none;font-size:16px;cursor:pointer;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center}
.plan-actions button:active{background:#eee}
.plan-create-btns{display:flex;flex-direction:column;gap:8px;margin-top:12px}
.plan-create-btns button{padding:12px;border-radius:10px;border:1.5px dashed #ccc;background:#fff;font-size:13px;cursor:pointer}
.plan-create-btns button:active{background:#f5f5f5}

/* Edit item panel */
.edit-panel{display:none;position:fixed;inset:0;z-index:250;background:rgba(0,0,0,.5);justify-content:flex-end}
.edit-panel.open{display:flex}
.edit-panel-inner{background:#fff;width:100%;max-width:400px;height:100%;overflow-y:auto;padding:20px 16px;animation:slideRight .25s ease}
@keyframes slideRight{from{transform:translateX(100%)}to{transform:translateX(0)}}
.edit-field{margin-bottom:14px}
.edit-field label{display:block;font-size:12px;font-weight:600;color:var(--text2);margin-bottom:4px}
.edit-field input,.edit-field textarea,.edit-field select{width:100%;padding:10px;border:1.5px solid #ddd;border-radius:8px;font-size:14px;font-family:inherit}
.edit-field textarea{height:80px;resize:vertical}
.edit-field input:focus,.edit-field textarea:focus,.edit-field select:focus{outline:none;border-color:var(--pink)}
.edit-field .coord-display{font-size:12px;color:var(--text2);padding:8px;background:#f5f5f5;border-radius:8px}

/* Places search */
.places-results{list-style:none;border:1px solid #ddd;border-top:none;border-radius:0 0 8px 8px;max-height:200px;overflow-y:auto;display:none}
.places-results.show{display:block}
.places-results li{padding:10px;font-size:13px;cursor:pointer;border-bottom:1px solid #f0f0f0}
.places-results li:active,.places-results li:hover{background:#f5f5f5}

/* Toast */
.toast{position:fixed;bottom:calc(var(--tab-h) + var(--safe-bottom) + 16px);left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:10px 20px;border-radius:24px;font-size:13px;z-index:300;display:flex;align-items:center;gap:10px;box-shadow:0 4px 12px rgba(0,0,0,.3);animation:fadeIn .2s}
.toast button{background:var(--pink);color:#fff;border:none;padding:4px 12px;border-radius:12px;font-size:12px;font-weight:600;cursor:pointer}
@keyframes fadeIn{from{opacity:0;transform:translateX(-50%) translateY(10px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}

/* AI Review Modal */
.ai-modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:300;justify-content:center;align-items:center;padding:16px}
.ai-modal-overlay.open{display:flex}
.ai-modal{background:#fff;border-radius:16px;width:100%;max-width:600px;max-height:85vh;display:flex;flex-direction:column;overflow:hidden;animation:slideUp .25s ease}
.ai-modal-head{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;border-bottom:1px solid #eee}
.ai-modal-head h2{font-size:16px;margin:0}
.ai-modal-body{flex:1;overflow-y:auto;padding:20px;font-size:14px;line-height:1.7}
.ai-modal-body h1,.ai-modal-body h2,.ai-modal-body h3{margin:16px 0 8px;color:var(--pink-dark)}
.ai-modal-body h1{font-size:18px}.ai-modal-body h2{font-size:16px}.ai-modal-body h3{font-size:14px}
.ai-modal-body ul,.ai-modal-body ol{padding-left:20px;margin:8px 0}
.ai-modal-body li{margin:4px 0}
.ai-modal-body strong{color:var(--text)}
.ai-modal-body p{margin:8px 0}
.ai-spinner{text-align:center;padding:60px 20px;color:var(--text2)}
.ai-spinner .spin{display:inline-block;width:36px;height:36px;border:3px solid #eee;border-top-color:var(--pink);border-radius:50%;animation:spin .8s linear infinite;margin-bottom:12px}
@keyframes spin{to{transform:rotate(360deg)}}

/* Import Modal */
.import-modal textarea{width:100%;height:200px;border:1.5px solid #ddd;border-radius:8px;padding:10px;font-size:13px;font-family:monospace;resize:vertical}
.import-modal textarea:focus{outline:none;border-color:var(--pink)}
.import-modal .import-actions{display:flex;gap:8px;margin-top:12px}
.import-modal .import-actions button{flex:1;padding:12px;border-radius:10px;font-size:14px;font-weight:600;border:none;cursor:pointer}
.import-modal .btn-import{background:var(--pink);color:#fff}
.import-modal .btn-import:active{background:var(--pink-dark)}
.import-modal .btn-cancel{background:#eee;color:var(--text)}

/* Map search overlay */
.map-search{position:absolute;top:10px;left:10px;right:10px;z-index:500}
.map-search input{width:100%;padding:10px 40px 10px 36px;border:none;border-radius:24px;font-size:14px;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,.2);font-family:inherit}
.map-search input:focus{outline:none;box-shadow:0 2px 12px rgba(0,0,0,.3)}
.map-search .ms-icon{position:absolute;left:12px;top:11px;font-size:15px;pointer-events:none}
.map-search .ms-clear{position:absolute;right:8px;top:6px;background:none;border:none;font-size:18px;cursor:pointer;color:#999;width:28px;height:28px;border-radius:50%;display:none;align-items:center;justify-content:center}
.map-search .ms-clear.show{display:flex}
.map-search .ms-clear:active{background:#eee}
.map-search-results{list-style:none;background:#fff;border-radius:0 0 12px 12px;box-shadow:0 4px 12px rgba(0,0,0,.15);max-height:200px;overflow-y:auto;margin-top:-4px;display:none}
.map-search-results.show{display:block}
.map-search-results li{padding:10px 12px;font-size:13px;cursor:pointer;border-bottom:1px solid #f0f0f0}
.map-search-results li:last-child{border-bottom:none;border-radius:0 0 12px 12px}
.map-search-results li:active,.map-search-results li:hover{background:#f5f5f5}
.popup-add-btn{display:inline-block;margin-top:5px;padding:5px 10px;background:var(--pink);color:#fff;border-radius:6px;border:none;font-size:11px;font-weight:600;cursor:pointer}
.popup-add-btn:active{opacity:.7}

.gm-iw-content{font-size:12px;line-height:1.5}
.gm-iw-content .popup-title{font-weight:600;font-size:13px;margin-bottom:3px}
.popup-nav-btn{display:inline-block;margin-top:5px;padding:5px 10px;background:#4285f4;color:#fff !important;border-radius:6px;text-decoration:none;font-size:11px;font-weight:600}
.poi-card{max-width:320px;font-size:12px;line-height:1.5}
.poi-photos{display:flex;gap:4px;overflow-x:auto;margin-bottom:6px;scroll-snap-type:x mandatory}
.poi-photos img{width:140px;height:100px;object-fit:cover;border-radius:6px;scroll-snap-align:start;flex-shrink:0}
.poi-meta{color:#666;font-size:11px;margin:2px 0}
.poi-tags{display:flex;flex-wrap:wrap;gap:3px;margin:4px 0}
.poi-tags span{background:#f0f0f0;border-radius:10px;padding:1px 7px;font-size:10px;color:#555}
.poi-hours-toggle{color:#1a73e8;cursor:pointer;font-size:11px;border:none;background:none;padding:0;text-decoration:underline}
.poi-hours-full{display:none;font-size:11px;color:#555;margin:2px 0 4px 0;white-space:pre-line}
.poi-hours-full.open{display:block}
.poi-review{border-top:1px solid #eee;padding:4px 0;margin-top:4px}
.poi-review .stars{color:#fbbc04;font-size:11px}
.poi-review .author{font-weight:600;font-size:11px}
.poi-review .text{font-size:11px;color:#444;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden}
.poi-actions{margin-top:6px;display:flex;gap:6px}
.popup-call-btn{display:inline-block;margin-top:5px;padding:5px 10px;background:#2e7d32;color:#fff;border-radius:6px;text-decoration:none;font-size:11px}
.marker-num{width:22px;height:22px;line-height:22px;text-align:center;font-size:11px;font-weight:700;border-radius:50%;color:#fff;box-shadow:0 1px 3px rgba(0,0,0,.3)}
.marker-label{white-space:nowrap;padding:3px 8px;border-radius:12px;font-size:11px;font-weight:700;color:#fff;box-shadow:0 1px 4px rgba(0,0,0,.3);line-height:1.3}

.food-card{background:#fff;border-radius:12px;padding:12px;margin-bottom:10px;box-shadow:0 1px 3px rgba(0,0,0,.07)}
.food-card.highlight{box-shadow:0 0 0 2px #2196f3,0 2px 8px rgba(33,150,243,.3)}
.food-card .food-name{font-size:15px;font-weight:600}
.food-card .food-jp{font-size:15px;margin-top:4px;background:#f5f5f5;padding:6px 10px;border-radius:8px;font-weight:500}
.food-card .food-desc{font-size:13px;margin-top:8px;line-height:1.5}
.food-tag{display:inline-block;padding:2px 10px;border-radius:12px;font-size:11px;font-weight:500;margin-top:6px;margin-right:4px}
.food-tag.day{background:var(--pink-light);color:var(--pink-dark)}.food-tag.price{background:#e8f5e9;color:#2e7d32}.food-tag.rating{background:#fff3e0;color:#e65100}

.res-card{background:#fff;border-radius:12px;padding:14px;margin-bottom:10px;box-shadow:0 1px 3px rgba(0,0,0,.07)}
.res-group{border:1.5px solid #f8bbd0;border-radius:14px;padding:10px 10px 2px;margin-bottom:12px}
.res-group-header{font-size:12px;font-weight:600;color:var(--pink);margin-bottom:8px;padding-bottom:6px;border-bottom:1px dashed #f8bbd0}
.res-group .res-card{box-shadow:none;border:1px solid #eee;margin-bottom:8px;cursor:grab;user-select:none}
.res-group .res-card.dragging{opacity:.35;border:2px dashed var(--pink)!important}
.res-group .res-card.drag-over{border-top:3px solid var(--pink)!important}
.res-alt-badge{display:inline-block;font-size:10px;font-weight:700;color:#fff;background:var(--pink);border-radius:8px;padding:1px 6px;margin-right:5px;vertical-align:middle}
.res-drag-handle{font-size:14px;color:#ccc;margin-right:6px;cursor:grab;vertical-align:middle;letter-spacing:-1px}
.res-header{display:flex;justify-content:space-between;align-items:flex-start}
.res-name{font-size:15px;font-weight:600}
.res-date{font-size:11px;font-weight:600;color:#fff;background:var(--pink);padding:3px 10px;border-radius:12px;white-space:nowrap}
.res-info{margin-top:8px;font-size:12px;line-height:1.7;color:var(--text2)}
.res-actions{display:flex;gap:6px;margin-top:10px;flex-wrap:wrap}
.res-status{display:inline-flex;align-items:center;gap:4px;padding:5px 10px;border-radius:18px;font-size:11px;font-weight:500;border:1.5px solid #ddd;background:#fff;cursor:pointer;transition:.2s}
.res-status.confirmed{background:#e8f5e9;border-color:#4caf50;color:#2e7d32}
.res-status.rejected{background:#ffebee;border-color:#e57373;color:#c62828}
.res-status.walkin{background:#e3f2fd;border-color:#64b5f6;color:#1565c0}
.res-card.rejected{opacity:.45}
.res-card.rejected .res-name{text-decoration:line-through}

/* Fallback banner */
#fallback-banner{position:fixed;bottom:calc(var(--tab-h) + var(--safe-bottom));left:0;right:0;background:#e65100;color:#fff;text-align:center;font-size:12px;font-weight:600;padding:5px 12px;z-index:99;display:none}
body.fallback-mode #fallback-banner{display:block}
body.fallback-mode .content{height:calc(100dvh - var(--tab-h) - var(--safe-bottom) - 30px)}
</style>
</head>
<body>
<div id="fallback-banner">âš ï¸ è³‡æ–™åº«é€£ç·šå¤±æ•—ï¼Œç›®å‰é¡¯ç¤ºé è¨­ç‰ˆæœ¬ï¼ˆä¿®æ”¹ä¸æœƒå„²å­˜ï¼‰</div>
<div class="content">
  <div id="itinerary-page" class="page active">
    <div class="header">
      <div><h1>2026 ä½è³€æ—…è¡Œ</h1><div class="subtitle">2/26 (å››) ~ 3/3 (äºŒ) ãƒ» 6å¤©5å¤œ ï½œ <span id="activePlanLabel" style="cursor:pointer;text-decoration:underline;opacity:1" onclick="openPlanModal()"></span></div></div>
      <div class="header-btns">
        <!-- AIå¯©æŸ¥æŒ‰éˆ•æš«æ™‚éš±è— -->
        <button class="header-btn" id="btnAiReview" onclick="aiReview()" title="AI å¯©æŸ¥" style="display:none;font-size:12px;width:auto;padding:0 10px;border-radius:17px">ğŸ¤– AIå¯©æŸ¥</button>
        <button class="header-btn" onclick="exportItinerary()" title="åŒ¯å‡ºè¡Œç¨‹" style="font-size:12px;width:auto;padding:0 10px;border-radius:17px">ğŸ“¥ åŒ¯å‡º</button>
        <button class="header-btn" onclick="openImportModal()" title="åŒ¯å…¥è¡Œç¨‹" style="font-size:12px;width:auto;padding:0 10px;border-radius:17px">ğŸ“¤ åŒ¯å…¥</button>
        <button class="header-btn" id="btnPlans" onclick="openPlanModal()" title="è¡Œç¨‹æ–¹æ¡ˆ" style="font-size:12px;width:auto;padding:0 10px;border-radius:17px">ğŸ“‹ æ–¹æ¡ˆ</button>
        <button class="header-btn" id="btnEdit" onclick="toggleEditMode()" title="ç·¨è¼¯æ¨¡å¼" style="font-size:12px;width:auto;padding:0 10px;border-radius:17px">âœï¸ ç·¨è¼¯</button>
      </div>
    </div>
    <div class="day-chips" id="dayChips"></div>
    <div class="itin-body">
      <div id="cards-panel"></div>
      <div id="map-panel">
        <div class="map-search">
          <span class="ms-icon">ğŸ”</span>
          <input type="text" id="mapSearchInput" placeholder="æœå°‹åœ°é»..." oninput="onMapSearch(this.value)" autocomplete="off">
          <button class="ms-clear" id="mapSearchClear" onclick="clearMapSearch()">âœ•</button>
          <ul class="map-search-results" id="mapSearchResults"></ul>
        </div>
        <div id="map-container"></div>
      </div>
    </div>
  </div>
  <div id="food-page" class="page">
    <div class="header"><div><h1>ç¾é£ŸæŒ‡å—</h1><div class="subtitle">ç•¶åœ°ç‰¹è‰²ç¾é£Ÿ æ—¥æ–‡+ä¸­æ–‡ çµ¦åº—å“¡çœ‹</div></div></div>
    <div class="food-body">
      <div id="food-cards-panel"></div>
      <div id="food-map-panel"><div id="food-map-container"></div></div>
    </div>
  </div>
  <div id="res-page" class="page">
    <div class="header"><div><h1>é¤å»³é ç´„</h1><div class="subtitle">8 é–“é¤å»³é ç´„è³‡è¨Š</div></div><button class="header-btn" onclick="copyVisaFormat()" style="font-size:12px;width:auto;padding:0 10px;border-radius:17px">ğŸ“‹ è¤‡è£½ visa æ ¼å¼</button></div>
    <div class="page-scroll" id="resScroll"></div>
  </div>
</div>
<nav class="tab-bar">
  <button class="tab-item active" data-page="itinerary-page"><span class="icon">ğŸ“…</span>è¡Œç¨‹åœ°åœ–</button>
  <button class="tab-item" data-page="food-page"><span class="icon">ğŸ½</span>ç¾é£Ÿ</button>
  <button class="tab-item" data-page="res-page"><span class="icon">ğŸ“±</span>é ç´„</button>
</nav>

<!-- Plan Management Modal -->
<div class="modal-overlay" id="planModal">
  <div class="modal-panel">
    <div class="modal-header"><h2>ğŸ“‹ è¡Œç¨‹æ–¹æ¡ˆç®¡ç†</h2><button class="modal-close" onclick="closePlanModal()">âœ•</button></div>
    <div id="planList"></div>
    <div class="plan-create-btns">
      <button onclick="createEmptyPlan()">+ å»ºç«‹ç©ºç™½æ–¹æ¡ˆ</button>
      <button onclick="createFromDefault()">+ å¾åŸå§‹è¡Œç¨‹å»ºç«‹</button>
    </div>
  </div>
</div>

<!-- Edit Item Panel -->
<div class="edit-panel" id="editPanel">
  <div class="edit-panel-inner">
    <div class="modal-header"><h2 id="editPanelTitle">ç·¨è¼¯é …ç›®</h2><button class="modal-close" onclick="closeEditPanel()">âœ•</button></div>
    <div class="edit-field">
      <label>æœå°‹åœ°é» (Google Places)</label>
      <input type="text" id="epSearch" placeholder="è¼¸å…¥åœ°åæœå°‹..." oninput="onPlacesSearch(this.value)">
      <ul class="places-results" id="placesResults"></ul>
    </div>
    <div class="edit-field"><label>åç¨±</label><input type="text" id="epName"></div>
    <div class="edit-field"><label>æ™‚é–“ (HH:MM)</label><input type="text" id="epTime" placeholder="09:00"></div>
    <div class="edit-field"><label>åœç•™æ™‚é–“</label><input type="text" id="epDuration" placeholder="60åˆ†"></div>
    <div class="edit-field">
      <label>é¡å‹</label>
      <select id="epType">
        <option value="spot">ğŸ¯ æ™¯é»</option>
        <option value="restaurant">ğŸ½ é¤å»³</option>
        <option value="hotel">ğŸ¨ ä½å®¿</option>
        <option value="transport">ğŸš— äº¤é€š</option>
        <option value="snack">ğŸ¡ å°åƒ</option>
        <option value="airport">âœˆï¸ æ©Ÿå ´</option>
      </select>
    </div>
    <div class="edit-field"><label>åœ–ç¤º</label><input type="text" id="epIcon" placeholder="ğŸ¯"></div>
    <div class="edit-field"><label>åº§æ¨™ï¼ˆå”¯è®€ï¼‰</label><div class="coord-display" id="epCoords">å°šæœªè¨­å®š</div></div>
    <div class="edit-field"><label>å‚™æ³¨</label><textarea id="epNote"></textarea></div>
    <div class="edit-field"><label>é›»è©±</label><input type="text" id="epPhone"></div>
    <div class="edit-field"><label>è»Šç¨‹</label><input type="text" id="epDrive" placeholder="è»Šç¨‹ç´„30åˆ†"></div>
    <div class="edit-field"><label>Tabelog é€£çµ</label><input type="text" id="epTabelog" placeholder="https://tabelog.com/..."></div>
    <button class="btn btn-nav" style="margin-bottom:10px" onclick="autoCalcDistance()">ğŸ§® è‡ªå‹•è¨ˆç®—èˆ‡å‰ä¸€ç«™è·é›¢</button>
    <div style="display:flex;gap:8px;margin-top:10px">
      <button class="btn btn-edit" style="flex:1;justify-content:center;padding:12px;font-size:14px" onclick="saveEditItem()">ğŸ’¾ å„²å­˜</button>
      <button class="btn" style="flex:1;justify-content:center;padding:12px;font-size:14px;background:#eee" onclick="closeEditPanel()">å–æ¶ˆ</button>
    </div>
  </div>
</div>

<script>
// === DEFAULT ITINERARY DATA (read-only reference) ===
const TRIP_DATES=['2026-02-26','2026-02-27','2026-02-28','2026-03-01','2026-03-02','2026-03-03'];
const DAY_LABELS=['Day1 ä½è³€å¸‚','Day2 å”æ´¥','Day3 ä¼Šä¸‡é‡Œâ†’å¬‰é‡','Day4 è±ªæ–¯ç™»å ¡','Day5 é¹¿å³¶ãƒ»å¤ªè‰¯','Day6 å›ç¨‹'];
const DAY_SHORT=['D1','D2','D3','D4','D5','D6'];
const DAY_REGIONS=['ä½è³€å¸‚ãƒ»ç¥å´','å”æ´¥å¸‚ãƒ»å‘¼å­','ä¼Šä¸‡é‡Œâ†’æ­¦é›„â†’å¬‰é‡','å¬‰é‡â†’è±ªæ–¯ç™»å ¡','æ­¦é›„â†’é¹¿å³¶â†’å¤ªè‰¯','é¹¿å³¶â†’ä½è³€æ©Ÿå ´'];
const DAY_TIPS={
'2026-02-26':['æ‰€æœ‰æ™šé¤å·²é ç´„ 18:00ï¼Œè‹¥è¡Œç¨‹ææ—©/å»¶å¾Œå¯é›»è©±èª¿æ•´','å¸¶ 3æ­²+1æ­²å°å­© â†’ æ¯å¤©ä¸‹åˆé ç•™ 30åˆ†~1hr å½ˆæ€§æ™‚é–“ï¼Œä»¥é˜²å°å­©éœ€è¦ä¼‘æ¯'],
'2026-02-27':['åˆé¤ â†’ ã‹ã‚‰ã¤ãƒãƒ¼ã‚¬ãƒ¼ï¼ˆå”æ´¥æ¼¢å ¡ï¼‰12:10 åœ¨è™¹ã®æ¾åŸåƒï¼Œæ™‚é–“å‰›å¥½ï¼','æ‰€æœ‰æ™šé¤å·²é ç´„ 18:00ï¼Œè‹¥è¡Œç¨‹ææ—©/å»¶å¾Œå¯é›»è©±èª¿æ•´','å¸¶ 3æ­²+1æ­²å°å­© â†’ æ¯å¤©ä¸‹åˆé ç•™ 30åˆ†~1hr å½ˆæ€§æ™‚é–“ï¼Œä»¥é˜²å°å­©éœ€è¦ä¼‘æ¯'],
'2026-02-28':['åˆé¤ â†’ ä¼Šä¸‡é‡Œå¸‚å€è‡ªç”±è¦“é£Ÿï¼ˆæ¨è–¦ï¼šä¼Šä¸‡é‡Œç‰›å®šé£Ÿ or æ‹‰éºµï¼‰~12:00','æ‰€æœ‰æ™šé¤å·²é ç´„ 18:00ï¼Œè‹¥è¡Œç¨‹ææ—©/å»¶å¾Œå¯é›»è©±èª¿æ•´','å¸¶ 3æ­²+1æ­²å°å­© â†’ æ¯å¤©ä¸‹åˆé ç•™ 30åˆ†~1hr å½ˆæ€§æ™‚é–“ï¼Œä»¥é˜²å°å­©éœ€è¦ä¼‘æ¯'],
'2026-03-01':['åˆé¤ â†’ è±ªæ–¯ç™»å ¡åœ’å€å…§è§£æ±ºï¼ˆåœ’å…§å¤šé–“é¤å»³ï¼‰~12:00','æ‰€æœ‰æ™šé¤å·²é ç´„ 18:00ï¼Œè‹¥è¡Œç¨‹ææ—©/å»¶å¾Œå¯é›»è©±èª¿æ•´','å¸¶ 3æ­²+1æ­²å°å­© â†’ æ¯å¤©ä¸‹åˆé ç•™ 30åˆ†~1hr å½ˆæ€§æ™‚é–“ï¼Œä»¥é˜²å°å­©éœ€è¦ä¼‘æ¯'],
'2026-03-02':['å¤§é­šç¥ç¤¾ â†’ é€€æ½®æ™‚æµ·ä¸­é³¥å±…æœ€ç¾ï¼Œå»ºè­°æŸ¥ç•¶å¤©æ½®æ±è¡¨èª¿æ•´æ™‚é–“','æ‰€æœ‰æ™šé¤å·²é ç´„ 18:00ï¼Œè‹¥è¡Œç¨‹ææ—©/å»¶å¾Œå¯é›»è©±èª¿æ•´','å¸¶ 3æ­²+1æ­²å°å­© â†’ æ¯å¤©ä¸‹åˆé ç•™ 30åˆ†~1hr å½ˆæ€§æ™‚é–“ï¼Œä»¥é˜²å°å­©éœ€è¦ä¼‘æ¯'],
'2026-03-03':[]
};

const ITINERARY_DEFAULT={
'2026-02-26':[
  {time:'11:15',name:'æŠµé”ä½è³€æ©Ÿå ´',type:'airport',icon:'âœˆï¸',coords:[33.14972,130.30222],duration:'',note:'IT246 èˆªç­æŠµé”'},
  {time:'12:15',name:'åˆé¤ï¼ˆè‡ªç”±é¸æ“‡ï¼‰',type:'restaurant',icon:'ğŸ½',coords:[33.26159,130.30333],duration:'60åˆ†',note:'ä½è³€å¸‚å€åˆé¤'},
  {time:'13:10',name:'ç¥é‡å…¬åœ’å…’ç«¥éŠæˆ²å ´',type:'spot',icon:'ğŸ ',coords:[33.26511,130.28172],duration:'90åˆ†',note:'å…’ç«¥éŠæ¨‚å ´ï¼Œé©åˆ3æ­²å°å­©',drive:'è»Šç¨‹ç´„25åˆ†'},
  {time:'15:05',name:'å‰é‡ãƒ¶é‡Œæ­´å²å…¬åœ’',type:'spot',icon:'ğŸ¯',coords:[33.32394,130.38876],duration:'90åˆ†',note:'å¼¥ç”Ÿæ™‚ä»£éºè·¡å…¬åœ’ï¼Œå¯çœ‹å¤ä»£ä½å±…å¾©åŸ',drive:'è»Šç¨‹ç´„25åˆ†'},
  {time:'18:00',name:'ä½è³€ç‰›ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³å­£æ¥½ æœ¬åº—',type:'restaurant',icon:'ğŸ¥©',coords:[33.26159,130.30333],duration:'90åˆ†',note:'å·²é ç´„ 18:00ãƒ»ä½è³€ç‰›éµæ¿ç‡’/æ¶®æ¶®é‹\nÂ¥8,000~Â¥14,999\nTabelog 3.54 (446è©•)\nç™¾ååº—2024',phone:'0952-28-4132',tabelog:'https://tabelog.com/saga/A4101/A410101/41000012/',drive:'è»Šç¨‹ç´„30åˆ†'},
  {time:'20:00',name:'airbnb è‹¥å®®ã€‚è–°é¢¨',type:'hotel',icon:'ğŸ¨',coords:[33.2631,130.2980],duration:'',note:'å…¥ä½ä½è³€å¸‚å€æ°‘å®¿',drive:'è»Šç¨‹ç´„5åˆ†'}
],
'2026-02-27':[
  {time:'09:30',name:'å‡ºç™¼',type:'transport',icon:'ğŸš—',coords:[33.2631,130.2980],duration:''},
  {time:'10:05',name:'é¡ç¥ç¤¾ è³æ¢…èŠ±',type:'spot',icon:'ğŸŒ¸',coords:[33.43182,130.00841],gmap:'é¡ç¥ç¤¾',duration:'40åˆ†',note:'æ¢…èŠ±å­£ç¯€ï¼ˆ2-3æœˆï¼‰è³æ¢…åæ‰€',drive:'è»Šç¨‹ç´„35åˆ†'},
  {time:'11:00',name:'å”æ´¥åŸ',type:'spot',icon:'ğŸ¯',coords:[33.45351,129.97819],duration:'60åˆ†',note:'åˆ¥åã€Œèˆé¶´åŸã€ï¼Œå¤©å®ˆé–£å¯çœºæœ›å”æ´¥ç£',drive:'è»Šç¨‹ç´„15åˆ†'},
  {time:'12:10',name:'ã‹ã‚‰ã¤ãƒãƒ¼ã‚¬ãƒ¼ï¼ˆè™¹ã®æ¾åŸï¼‰',type:'snack',icon:'ğŸ”',coords:[33.44427,129.99984],duration:'30åˆ†',note:'å”æ´¥æ¼¢å ¡ãƒ»è™¹ã®æ¾åŸåç‰©\nè·¯é‚Šæ”¤è»Šãƒ»~Â¥500',phone:'0955-56-7119',drive:'è»Šç¨‹ç´„5åˆ†'},
  {time:'13:05',name:'å‘¼å­å°åƒï¼šã„ã‹ã—ã‚…ã†ã¾ã„ï¼‹é­šãƒ­ãƒƒã‚±',type:'snack',icon:'ğŸ¦‘',coords:[33.53709,129.89473],duration:'30åˆ†',note:'çƒè³Šç‡’è³£ï¼ˆè¬åŠ ç™ºç¥¥åº—ï¼‰~Â¥500\né­šè‚‰å¯æ¨‚é¤… ~Â¥200',drive:'è»Šç¨‹ç´„25åˆ†'},
  {time:'13:45',name:'ä¸ƒãƒ„é‡œ éŠè¦½èˆ¹ï¼ˆãƒãƒªãƒ³ãƒ‘ãƒ«å‘¼å­ï¼‰',type:'spot',icon:'â›µ',coords:[33.53760,129.89330],duration:'90åˆ†',note:'æŸ±çŠ¶ç¯€ç†æ´çªŸéŠèˆ¹é«”é©—\nå¾ãƒãƒªãƒ³ãƒ‘ãƒ«å‘¼å­å‡ºç™¼\nå¤©å€™ä¸ä½³å¯èƒ½åœèˆª',drive:'æ­¥è¡Œå¯é”'},
  {time:'15:15',name:'å‘¼å­å‘¨é‚Šè‡ªç”±æ´»å‹•',type:'spot',icon:'ğŸš¶',coords:[33.53709,129.89473],duration:'105åˆ†',note:'å‘¼å­æœå¸‚é€šæ•£æ­¥ã€æµ·é‚Šæ•£æ­¥',drive:''},
  {time:'18:00',name:'ã„ã‹ã®æ´»é€ ã‚Š å¤§å’Œ',type:'restaurant',icon:'ğŸ¦‘',coords:[33.52847,129.87946],duration:'90åˆ†',note:'å·²é ç´„ 18:00ãƒ»æ´»çƒè³Šé€ ã‚Š\nã‚¤ã‚«ã®æ´»ãé€ ã‚Šå®šé£Ÿï¼ˆä¸€é­šå…©åƒï¼‰\nå…ˆåˆºèº«ã€å†å¤©å©¦ç¾…\nÂ¥3,000~Â¥3,999ãƒ»Tabelog 3.72',phone:'0955-82-3643',tabelog:'https://tabelog.com/saga/A4102/A410201/41000157/',drive:'è»Šç¨‹ç´„5åˆ†'},
  {time:'20:00',name:'Riverside Hotel å”æ´¥åŸ',type:'hotel',icon:'ğŸ¨',coords:[33.45034,129.98216],duration:'',note:'å”æ´¥å¸‚å€é£¯åº—',drive:'è»Šç¨‹ç´„30åˆ†'}
],
'2026-02-28':[
  {time:'09:30',name:'å‡ºç™¼',type:'transport',icon:'ğŸš—',coords:[33.45034,129.98216],duration:''},
  {time:'10:00',name:'æ¿±é‡æµ¦æ¢¯ç”°å±•æœ›å°',type:'spot',icon:'ğŸŒ¾',coords:[33.48925,129.84735],duration:'30åˆ†',note:'æ—¥æœ¬æ£šç”°ç™¾é¸ä¹‹ä¸€ï¼Œæ‹ç…§æ™¯é»',drive:'è»Šç¨‹ç´„25åˆ†'},
  {time:'11:10',name:'ä¼Šä¸‡é‡Œæ¢…åœ’ è—¤ãƒå°¾',type:'spot',icon:'ğŸŒ¸',coords:[33.29203,129.87567],duration:'50åˆ†',note:'ä¼Šè¬é‡Œæ¢…èŠ±åœ’ï¼Œ2-3æœˆç››é–‹',drive:'è»Šç¨‹ç´„40åˆ†'},
  {time:'12:00',name:'ä¼Šä¸‡é‡Œå¸‚å€åˆé¤',type:'restaurant',icon:'ğŸ½',coords:[33.29203,129.87567],duration:'60åˆ†',note:'å¯å˜—è©¦ä¼Šè¬é‡Œç‰›'},
  {time:'13:40',name:'å¾¡èˆ¹å±±æ¨‚åœ’',type:'spot',icon:'â›°ï¸',coords:[33.18230,130.01798],duration:'90åˆ†',note:'åœ‹ç™»éŒ„ç´€å¿µç‰©ãƒ»åº­åœ’\nteamLabå±•è¦½ï¼ˆå¦‚æœ‰é–‹æ”¾ï¼‰',drive:'è»Šç¨‹ç´„40åˆ†'},
  {time:'15:20',name:'ãŸã‘ãŠæ¸©æ³‰ã·ã‚Šã‚“ï¼ˆæ­¦é›„æ¸©æ³‰ç‰©ç”£é¤¨ï¼‰',type:'snack',icon:'ğŸ®',coords:[33.19656,130.03251],duration:'20åˆ†',note:'æ­¦é›„æº«æ³‰å¸ƒä¸ ~Â¥400\nä½è³€ç”œé»é¸èˆ‰2024 å¸ƒä¸é¡ç¬¬1å\nç‡Ÿæ¥­è‡³17:15',drive:'è»Šç¨‹ç´„5åˆ†'},
  {time:'16:00',name:'ã†ã‚Œã—ã®SHUãƒ—ãƒªãƒ³',type:'snack',icon:'ğŸµ',coords:[33.10110,129.99896],duration:'20åˆ†',note:'å¬‰é‡æº«æ³‰å¸ƒä¸ Â¥300~Â¥400\nä½¿ç”¨å¬‰é‡ç¶ èŒ¶è£½ä½œï¼Œç ”ç™¼3å¹´',drive:'è»Šç¨‹ç´„25åˆ†'},
  {time:'18:00',name:'é·¹é®¨ï¼ˆTaka Zushiï¼‰',type:'restaurant',icon:'ğŸ£',coords:[33.09796,129.98412],duration:'90åˆ†',note:'å·²é ç´„ 18:00ãƒ»å£½å¸/æµ·é®®\nåƒ…7åº§ä½ï¼ˆå«å€‹å®¤ï¼‰\nå†¬å­£æ™‚ä»¤ï¼šãƒ’ãƒ©ãƒ¡ï¼ˆæ¯”ç›®é­šï¼‰ã€é¯›\nÂ¥5,000~Â¥5,999ãƒ»Tabelog 3.17',phone:'0954-43-3210',tabelog:'https://tabelog.com/saga/A4104/A410401/41002823/',drive:'è»Šç¨‹ç´„5åˆ†'},
  {time:'20:00',name:'Hotel Sakura å¬‰é‡',type:'hotel',icon:'ğŸ¨',coords:[33.09747,129.98513],duration:'',note:'å¬‰é‡æº«æ³‰ä½å®¿ï¼ˆä½2æ™šï¼‰',drive:'è»Šç¨‹ç´„3åˆ†'}
],
'2026-03-01':[
  {time:'09:35',name:'å¬‰é‡æ¸©æ³‰æ¹¯è±†è… æ—©åˆé¤',type:'restaurant',icon:'ğŸ«•',coords:[33.09796,129.98412],duration:'60åˆ†',note:'ä½å˜‰å¹³å·å±‹ or å®—åºµã‚ˆã“é•·\nå¬‰é‡æ¸©æ³‰æ°´å°‡è±†è…æº¶æˆè±†ä¹³èˆ¬\nå…¨æ—¥æœ¬ç¨ç‰¹ãƒ»Â¥1,000~Â¥2,000'},
  {time:'11:00',name:'è±ªæ–¯ç™»å ¡ Huis Ten Bosch',type:'spot',icon:'ğŸ¡',coords:[33.08547,129.78854],duration:'330åˆ†',note:'è·è˜­é¢¨ä¸»é¡Œæ¨‚åœ’\nå…¨å¤©éŠç©',drive:'è»Šç¨‹ç´„50åˆ†'},
  {time:'12:00',name:'åœ’å…§åˆé¤',type:'restaurant',icon:'ğŸ½',coords:[33.08547,129.78854],duration:'60åˆ†',note:'è±ªæ–¯ç™»å ¡åœ’å…§ç”¨é¤'},
  {time:'16:30',name:'é›¢é–‹è±ªæ–¯ç™»å ¡',type:'transport',icon:'ğŸš—',coords:[33.08547,129.78854],duration:''},
  {time:'18:00',name:'PIZZERIA MONTE STELLA',type:'restaurant',icon:'ğŸ•',coords:[33.09752,129.98103],duration:'90åˆ†',note:'å·²é ç´„ 18:00ãƒ»æ‹¿å¡é‡Œçª¯çƒ¤æŠ«è–©\nä¸»å»šèµ´ç¾©å­¸è—\nÂ¥3,000~Â¥3,999ãƒ»Tabelog 3.08\né€£åƒ3å¤©æ—¥æ–™å¾Œæ›å£å‘³',phone:'0954-20-2020',tabelog:'https://tabelog.com/saga/A4104/A410401/41006437/',drive:'è»Šç¨‹ç´„50åˆ†'},
  {time:'20:00',name:'Hotel Sakura å¬‰é‡ï¼ˆç¬¬2æ™šï¼‰',type:'hotel',icon:'ğŸ¨',coords:[33.09747,129.98513],duration:'',note:'å¬‰é‡æº«æ³‰ä½å®¿',drive:'è»Šç¨‹ç´„5åˆ†'}
],
'2026-03-02':[
  {time:'09:30',name:'å‡ºç™¼',type:'transport',icon:'ğŸš—',coords:[33.09747,129.98513],duration:''},
  {time:'09:45',name:'æ­¦é›„ãƒ»å¬‰é‡ ç«¥è©±æ‘',type:'spot',icon:'ğŸ§š',coords:[33.12990,129.97640],duration:'75åˆ†',note:'å…’ç«¥ä¸»é¡ŒéŠæ¨‚åœ’',drive:'è»Šç¨‹ç´„15åˆ†'},
  {time:'12:00',name:'å·ã—ãŸï¼ˆç«¹å´èŸ¹æ–™ç†ï¼‰',type:'restaurant',icon:'ğŸ¦€',coords:[32.99168,130.19091],duration:'90åˆ†',note:'å·²é ç´„ 12:00ï¼ˆåˆé¤ï¼‰\nã‹ã«é‡œé£¯ã‚»ãƒƒãƒˆ Â¥2,500\nã‹ã«å¾¡è†³ Â¥4,400~Â¥6,600\n3æœˆ=æ¯èŸ¹æœ‰å…§å­ï¼ˆèŸ¹åµï¼‰\næœ‰æ´»èŸ¹æ°´æ—ç®±ã€å…’ç«¥é¤',phone:'0954-68-2645',drive:'è»Šç¨‹ç´„40åˆ†'},
  {time:'13:40',name:'å¤§é­šç¥ç¤¾ æµ·ä¸­é³¥å±…',type:'spot',icon:'â›©ï¸',coords:[33.03123,130.17775],duration:'30åˆ†',note:'æœ‰æ˜æµ·ä¸­çš„æœ±ç´…é³¥å±…\né€€æ½®æ™‚å¯æ­¥è¡Œé è¿‘',drive:'è»Šç¨‹ç´„15åˆ†'},
  {time:'14:25',name:'ç«¹å´æµ·ç”£ï¼ˆç‚­çƒ¤ç‰¡è £å°å±‹ï¼‰',type:'snack',icon:'ğŸ¦ª',coords:[33.03917,130.17136],duration:'60åˆ†',note:'ç‚­çƒ¤ç«¹å´ç‰¡è £ Â¥2,000~Â¥2,999\n2æœˆ=ç‰¡è £æœ€è‚¥ç¾\nå¹³æ—¥ç‡Ÿæ¥­è‡³16:30',phone:'0954-67-0603',drive:'è»Šç¨‹ç´„5åˆ†'},
  {time:'18:00',name:'å¯¿ã—æ”¿ï¼ˆSushi Masaï¼‰',type:'restaurant',icon:'ğŸ£',coords:[33.08103,130.10901],duration:'90åˆ†',note:'å·²é ç´„ 18:00ãƒ»æœ‰æ˜æµ·å£½å¸\nÂ¥2,000~Â¥2,999ãƒ»Tabelog 3.36\né€±ä¸€ç‡Ÿæ¥­ï¼ˆé‡è¦ï¼é€±å››ä¼‘ï¼‰\nå€‹å®¤å¯ã€å¬°å…’è»Šå¯',phone:'0954-62-5617',tabelog:'https://tabelog.com/saga/A4104/A410402/41001116/',drive:'è»Šç¨‹ç´„25åˆ†'},
  {time:'20:00',name:'airbnb é¹¿å³¶',type:'hotel',icon:'ğŸ¨',coords:[33.1030,130.1020],duration:'',note:'é¹¿å³¶å¸‚æ°‘å®¿',drive:'è»Šç¨‹ç´„10åˆ†'}
],
'2026-03-03':[
  {time:'09:00',name:'å‡ºç™¼å‰å¾€æ©Ÿå ´ï¼ˆææ—©å‡ºé–€ï¼ï¼‰',type:'transport',icon:'ğŸš—',coords:[33.1030,130.1020],duration:''},
  {time:'09:40',name:'æŠµé”ä½è³€æ©Ÿå ´',type:'airport',icon:'âœˆï¸',coords:[33.14972,130.30222],duration:'',note:'æå‰1.5å°æ™‚åˆ°æ©Ÿå ´',drive:'è»Šç¨‹ç´„40åˆ†'},
  {time:'11:25',name:'IT247 èµ·é£›',type:'airport',icon:'ğŸ›«',coords:[33.14972,130.30222],duration:'',note:'ä½è³€â†’æ¡ƒåœ’'},
  {time:'13:05',name:'æŠµé”æ¡ƒåœ’æ©Ÿå ´',type:'airport',icon:'ğŸ ',coords:[25.0797,121.2342],duration:'',note:'åˆ°å®¶ï¼è¾›è‹¦äº†ï½'}
]};

const foods=[
  {name:'ä½è³€ç‰›éµæ¿ç‡’',jp:'ä½è³€ç‰›ã‚¹ãƒ†ãƒ¼ã‚­',day:'Day1',where:'å­£æ¥½ æœ¬åº—',price:'Â¥8,000~Â¥14,999',rating:'5/5',desc:'æ—¥æœ¬é ‚ç´šå’Œç‰›ä¹‹ä¸€ï¼ŒA5ç­‰ç´šä½è³€ç‰›ã€‚éµæ¿ç¾ç…æˆ–æ¶®æ¶®é‹ã€‚æ²¹èŠ±å…¥å£å³åŒ–ã€‚',coords:[33.26159,130.30333],gmap:'ä½è³€ç‰›ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³å­£æ¥½ æœ¬åº—'},
  {name:'æ´»çƒè³Šé€ ã‚Šï¼ˆä¸€é­šå…©åƒï¼‰',jp:'ã‚¤ã‚«ã®æ´»ãé€ ã‚Šå®šé£Ÿ',day:'Day2',where:'å¤§å’Œï¼ˆå‘¼å­ï¼‰',price:'Â¥3,000~Â¥3,999',rating:'5/5',desc:'å‘¼å­åç‰©ï¼é€æ˜æ´»çƒè³Šç¾åˆ‡åˆºèº«ï¼Œé°­å†ç‚¸å¤©å©¦ç¾…ã€‚2-3æœˆç‚ºãƒ¤ãƒªã‚¤ã‚«ï¼ˆæ§çƒè³Šï¼‰æ—ºå­£ã€‚',coords:[33.52847,129.87946],gmap:'ã„ã‹ã®æ´»é€ ã‚Š å¤§å’Œ å‘¼å­'},
  {name:'å”æ´¥æ¼¢å ¡',jp:'ã‹ã‚‰ã¤ãƒãƒ¼ã‚¬ãƒ¼',day:'Day2',where:'è™¹ã®æ¾åŸè·¯é‚Šæ”¤',price:'~Â¥500',rating:'5/5',desc:'è™¹ã®æ¾åŸåç‰©ï¼Œè·¯é‚Šæ”¤è»Šè²©å”®çš„ç¶“å…¸æ¼¢å ¡ã€‚',coords:[33.44427,129.99984],gmap:'ã‹ã‚‰ã¤ãƒãƒ¼ã‚¬ãƒ¼ è™¹ã®æ¾åŸ'},
  {name:'çƒè³Šç‡’è³£',jp:'ã„ã‹ã—ã‚…ã†ã¾ã„',day:'Day2',where:'è¬åŠ å‘¼å­æœå¸‚é€šã‚Šåº—',price:'~Â¥500',rating:'5/5',desc:'å‘¼å­ç™¼ç¥¥ï¼çƒè³Šè‚‰è£½æˆçš„ç‡’è³£ï¼Œå¤–é…¥å…§å½ˆã€‚',coords:[33.53709,129.89473],gmap:'è¬åŠ å‘¼å­æœå¸‚é€šã‚Šåº—'},
  {name:'é­šè‚‰å¯æ¨‚é¤…',jp:'é­šãƒ­ãƒƒã‚±',day:'Day2',where:'å‘¼å­è¡—é‚Šå°æ”¤',price:'~Â¥200',rating:'4/5',desc:'é­šæ¼¿è£½æˆçš„å¯æ¨‚é¤…ï¼Œç‚¸å¾—é‡‘é»ƒé…¥è„†ã€‚',coords:[33.53709,129.89473],gmap:'é­šãƒ­ãƒƒã‚± å‘¼å­'},
  {name:'æ­¦é›„æº«æ³‰å¸ƒä¸',jp:'ãŸã‘ãŠæ¸©æ³‰ã·ã‚Šã‚“',day:'Day3',where:'æ­¦é›„æ¸©æ³‰ç‰©ç”£é¤¨',price:'~Â¥400',rating:'5/5',desc:'ä½è³€ç”œé»é¸èˆ‰2024å¸ƒä¸é¡ç¬¬1åï¼æ»‘é †æ¿ƒéƒã€‚',coords:[33.19656,130.03251],gmap:'æ­¦é›„æ¸©æ³‰ç‰©ç”£é¤¨'},
  {name:'å¬‰é‡ç¶ èŒ¶å¸ƒä¸',jp:'ã†ã‚Œã—ã®SHUãƒ—ãƒªãƒ³',day:'Day3',where:'å¬‰é‡æº«æ³‰è¡—',price:'Â¥300~Â¥400',rating:'4/5',desc:'ä½¿ç”¨å¬‰é‡ç¶ èŒ¶è£½ä½œï¼Œç ”ç™¼3å¹´çš„æŠ¹èŒ¶å¸ƒä¸ã€‚',coords:[33.10110,129.99896],gmap:'ã†ã‚Œã—ã®SHUãƒ—ãƒªãƒ³ å¬‰é‡'},
  {name:'å¬‰é‡æº«æ³‰æ¹¯è±†è…',jp:'å¬‰é‡æ¸©æ³‰æ¹¯ã©ã†ãµ',day:'Day4',where:'ä½å˜‰å¹³å·å±‹ / å®—åºµã‚ˆã“é•·',price:'Â¥1,000~Â¥2,000',rating:'5/5',desc:'å…¨æ—¥æœ¬ç¨ç‰¹ï¼å¬‰é‡æº«æ³‰æ°´å°‡è±†è…æº¶æˆçµ²æ»‘è±†ä¹³ç‹€ã€‚å£æ„Ÿå¦‚å¥¶æ²¹èˆ¬æ»‘é †ï¼Œæ—©é¤æœ€æ¨ã€‚',coords:[33.09796,129.98412],gmap:'ä½å˜‰å¹³å·å±‹ å¬‰é‡æ¸©æ³‰'},
  {name:'ç«¹å´èŸ¹é‡œé£¯',jp:'ã‹ã«é‡œé£¯ã‚»ãƒƒãƒˆ',day:'Day5',where:'å·ã—ãŸ',price:'Â¥2,500',rating:'5/5',desc:'ç”¨ç«¹å´èŸ¹è‚‰ç¾ç…®çš„é‡œé£¯ã€‚3æœˆ=æ¯èŸ¹å­£ç¯€ï¼Œå…§å­ï¼ˆèŸ¹åµï¼‰ç‰¹åˆ¥è±å¯Œã€‚',coords:[32.99168,130.19091],gmap:'å·ã—ãŸ å¤ªè‰¯'},
  {name:'ç‚­çƒ¤ç«¹å´ç‰¡è £',jp:'ç‚­ç„¼ãç«¹å´ã‚«ã‚­',day:'Day5',where:'ç«¹å´æµ·ç”£',price:'Â¥2,000~Â¥2,999',rating:'5/5',desc:'2æœˆæ˜¯ç‰¡è £æœ€è‚¥ç¾çš„å­£ç¯€ï¼åœ¨ç‰¡è £å°å±‹ç‚­ç«ç¾çƒ¤ï¼Œé®®ç”œå¤šæ±ã€‚',coords:[33.03917,130.17136],gmap:'ç«¹å´æµ·ç”£'},
  {name:'æœ‰æ˜æµ·å£½å¸',jp:'æœ‰æ˜æµ·ã®å¯¿å¸',day:'Day5',where:'å¯¿ã—æ”¿',price:'Â¥2,000~Â¥2,999',rating:'4/5',desc:'ä½¿ç”¨æœ‰æ˜æµ·ç•¶æ—¥æ–°é®®æ¼ç²çš„å£½å¸ï¼Œå‘³é“é®®ç¾ã€‚',coords:[33.08103,130.10901],gmap:'å¯¿ã—æ”¿ é¹¿å³¶'}
];

const reservations=[
  {name:'ä½è³€ç‰›ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³å­£æ¥½ æœ¬åº—',zh:'ä½è³€ç‰›éµæ¿ç‡’é¤å»³ å­£æ¥½',date:'2/26 (å››)',time:'18:00',phone:'0952-28-4132',tabelog:'https://tabelog.com/saga/A4101/A410101/41000012/',cuisine:'ä½è³€ç‰›éµæ¿ç‡’/æ¶®æ¶®é‹',price:'Â¥8,000~Â¥14,999',pax:'2å¤§2å°(3æ­²ã€1æ­²)',note:'ç¦è¸ãƒ»æœ‰å€‹å®¤\nç™¾ååº—2024',coords:[33.26159,130.30333]},
  {name:'ç„¼é³¥ã‹ã©å±‹ ä½è³€é§…åŒ—å£åº—',zh:'ç‡’é³¥è§’å±‹ ä½è³€é§…åŒ—å£åº—',date:'2/26 (å››)',time:'18:00',phone:'0952-37-1330',tabelog:'https://tabelog.com/saga/A4101/A410101/41000155/',cuisine:'ç„¼ãé³¥/å±…é…’å±‹',price:'Â¥3,000~Â¥3,999',pax:'2å¤§2å°(3æ­²ã€1æ­²)',note:'ç¦è¸ãƒ»æœ‰å€‹å®¤(6é–“)\nä¹³å…å¯ãƒ»é§…åŒ—å£1åˆ†ãƒ»ä¸å®šä¼‘',coords:[33.2717,130.2997]},
  {name:'é…’ã¨é£¯ è±†ãŸã‚“',zh:'é…’ã¨é£¯ è±†ãŸã‚“',date:'2/26 (å››)',time:'18:00',phone:'0952-37-3381',tabelog:'https://tabelog.com/saga/A4101/A410101/41006933/',cuisine:'ç…®ä¸²/ä½è³€ç‰›/æµ·é®®',price:'Â¥3,000~Â¥3,999',pax:'2å¤§2å°(3æ­²ã€1æ­²)',note:'ç¦è¸ãƒ»æœ‰å€‹å®¤(6é–“)\nä¹³å…å¯ãƒ»é§…å—å£4åˆ†ãƒ»é€±æ—¥ä¼‘',coords:[33.2670,130.3018]},
  {name:'ã„ã‹ã®æ´»é€ ã‚Š å¤§å’Œ',zh:'æ´»çƒè³Šé€ ã‚Š å¤§å’Œ',date:'2/27 (äº”)',time:'18:00',phone:'0955-82-3643',tabelog:'https://tabelog.com/saga/A4102/A410201/41000157/',cuisine:'æ´»çƒè³Šåˆºèº«/æµ·é®®',price:'Â¥3,000~Â¥3,999',pax:'2å¤§2å°(3æ­²ã€1æ­²)',note:'ç¦è¸ãƒ»è«‹å…ˆç¢ºèªçƒè³Šä¾›æ‡‰\nï¼ˆå¤©å€™/æ¼ç²å½±éŸ¿ï¼‰',coords:[33.52847,129.87946]},
  {name:'é·¹é®¨ (Taka Zushi)',zh:'é·¹é®¨',date:'2/28 (å…­)',time:'18:00',phone:'0954-43-3210',tabelog:'https://tabelog.com/saga/A4104/A410401/41002823/',cuisine:'å£½å¸/æµ·é®®',price:'Â¥5,000~Â¥5,999',pax:'2å¤§2å°(3æ­²ã€1æ­²)',note:'ç¦è¸ãƒ»æ¦»æ¦»ç±³å€‹å®¤4äºº\nåƒ…7åº§ä½ãƒ»å‹™å¿…é ç´„\né€±ä¸‰ä¼‘',coords:[33.09796,129.98412]},
  {name:'PIZZERIA MONTE STELLA',zh:'è’™ç‰¹æ–¯ç‰¹æ‹‰çª¯çƒ¤æŠ«è–©',date:'3/1 (æ—¥)',time:'18:00',phone:'0954-20-2020',tabelog:'https://tabelog.com/saga/A4104/A410401/41006437/',cuisine:'æ‹¿å¡é‡Œçª¯çƒ¤æŠ«è–©',price:'Â¥3,000~Â¥3,999',pax:'2å¤§2å°(3æ­²ã€1æ­²)',note:'ç¦è¸ãƒ»å…’ç«¥å¯\nä¸»å»šèµ´ç¾©å­¸è—',coords:[33.09752,129.98103]},
  {name:'å·ã—ãŸ (Kawashita)',zh:'å·ä¸‹ ç«¹å´èŸ¹æ–™ç†',date:'3/2 (ä¸€)',time:'12:00 åˆé¤',phone:'0954-68-2645',tabelog:'',cuisine:'ç«¹å´èŸ¹æ–™ç†',price:'Â¥2,500~Â¥6,600',pax:'2å¤§2å°(3æ­²ã€1æ­²)',note:'ç¦è¸ãƒ»æœ‰å€‹å®¤ï¼ˆ3é–“ï¼‰\næœ‰å…’ç«¥é¤ãƒ»11:00~19:00ç‡Ÿæ¥­',coords:[32.99168,130.19091]},
  {name:'å¯¿ã—æ”¿ (Sushi Masa)',zh:'å£½å¸æ”¿',date:'3/2 (ä¸€)',time:'18:00',phone:'0954-62-5617',tabelog:'https://tabelog.com/saga/A4104/A410402/41001116/',cuisine:'å£½å¸/æœ‰æ˜æµ·æµ·é®®',price:'Â¥2,000~Â¥2,999',pax:'2å¤§2å°(3æ­²ã€1æ­²)',note:'ç¦è¸ãƒ»å€‹å®¤å¯ãƒ»å¬°å…’è»Šå¯\né€±ä¸€ç‡Ÿæ¥­ãƒ»é€±å››ä¼‘',coords:[33.08103,130.10901]}
];

// === STATE ===
let currentDay=0, currentPage='itinerary-page', googleMap=null, mapMarkers=[], mapLines=[];
let foodMap=null, foodMarkers=[];
let gInfoWindow=null, foodInfoWindow=null;
let resStatusMap={};
let resOrder=[];
let editMode=false;
let editingIdx=-1; // -1 = new item
let editingCoords=null;
let placesTimeout=null;
let mapSearchTimeout=null;
let mapSearchMarker=null;
let mapSearchResult=null; // store last selected search result
let undoItem=null, undoTimeout=null;
let dragSrcIdx=null;

// === MULTI-PLAN MANAGEMENT ===
function genId(){return Math.random().toString(36).substr(2,8)}
// === æ–¹æ¡ˆè³‡æ–™ï¼ˆç´”è¨˜æ†¶é«” + DBï¼Œä¸ç”¨ localStorageï¼‰===
let _plansCache=null;
function defaultPlans(){return {plans:[{id:'default',name:'ä½è³€åŸå§‹ç‰ˆ',data:JSON.parse(JSON.stringify(ITINERARY_DEFAULT)),createdAt:new Date().toISOString()}],activeId:'default'}}
function loadPlans(){
  if(!_plansCache) _plansCache=defaultPlans();
  return _plansCache;
}
function savePlansData(plans){
  _plansCache=plans;
  fetch('/api/data/trip_plans',{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(plans)}).catch(()=>{});
}
function savePlans(){savePlansData(loadPlans())}
function getActivePlan(){
  const plans=loadPlans();
  return plans.plans.find(p=>p.id===plans.activeId)||plans.plans[0];
}
function getActiveItinerary(){return getActivePlan().data}
function updateActiveItinerary(data){
  const plans=loadPlans();
  const p=plans.plans.find(p=>p.id===plans.activeId);
  if(p) p.data=data;
  savePlansData(plans);
}
function switchPlan(id){
  const plans=loadPlans();
  plans.activeId=id;
  savePlansData(plans);
  renderItinerary(); renderMap(); renderPlanList();
}
function duplicatePlan(id){
  const plans=loadPlans();
  const src=plans.plans.find(p=>p.id===id);
  if(!src) return;
  const name=prompt('æ–°æ–¹æ¡ˆåç¨±ï¼š',src.name+' å‰¯æœ¬');
  if(!name) return;
  plans.plans.push({id:genId(),name,data:JSON.parse(JSON.stringify(src.data)),createdAt:new Date().toISOString()});
  savePlansData(plans);
  renderPlanList();
}
function deletePlan(id){
  const plans=loadPlans();
  if(plans.plans.length<=1){alert('è‡³å°‘ä¿ç•™ä¸€å¥—æ–¹æ¡ˆ');return}
  if(plans.activeId===id){alert('ä¸èƒ½åˆªé™¤ç›®å‰ä½¿ç”¨ä¸­çš„æ–¹æ¡ˆ');return}
  if(!confirm('ç¢ºå®šåˆªé™¤æ­¤æ–¹æ¡ˆï¼Ÿ')) return;
  plans.plans=plans.plans.filter(p=>p.id!==id);
  savePlansData(plans);
  renderPlanList();
}
function renamePlan(id){
  const plans=loadPlans();
  const p=plans.plans.find(p=>p.id===id);
  if(!p) return;
  const name=prompt('é‡æ–°å‘½åï¼š',p.name);
  if(!name) return;
  p.name=name;
  savePlansData(plans);
  renderPlanList();
}
function createEmptyPlan(){
  const name=prompt('æ–°æ–¹æ¡ˆåç¨±ï¼š','æ–°æ–¹æ¡ˆ');
  if(!name) return;
  const plans=loadPlans();
  const data={};
  TRIP_DATES.forEach(d=>data[d]=[]);
  plans.plans.push({id:genId(),name,data,createdAt:new Date().toISOString()});
  savePlansData(plans);
  renderPlanList();
}
function createFromDefault(){
  const name=prompt('æ–°æ–¹æ¡ˆåç¨±ï¼š','ä½è³€åŸå§‹ç‰ˆ å‰¯æœ¬');
  if(!name) return;
  const plans=loadPlans();
  plans.plans.push({id:genId(),name,data:JSON.parse(JSON.stringify(ITINERARY_DEFAULT)),createdAt:new Date().toISOString()});
  savePlansData(plans);
  renderPlanList();
}

// === PLAN MODAL ===
function openPlanModal(){
  document.getElementById('planModal').classList.add('open');
  renderPlanList();
}
function closePlanModal(){document.getElementById('planModal').classList.remove('open')}
function renderPlanList(){
  const plans=loadPlans();
  const el=document.getElementById('planList');
  el.innerHTML=plans.plans.map(p=>{
    const active=p.id===plans.activeId;
    const days=Object.values(p.data).reduce((s,a)=>s+a.length,0);
    return `<div class="plan-item${active?' active-plan':''}" onclick="switchPlan('${p.id}')">
      <div class="plan-radio"></div>
      <div class="plan-name">${p.name}<div style="font-size:11px;color:var(--text2)">${days} å€‹é …ç›®</div></div>
      <div class="plan-actions" onclick="event.stopPropagation()">
        <button onclick="renamePlan('${p.id}')" title="é‡æ–°å‘½å">âœï¸</button>
        <button onclick="duplicatePlan('${p.id}')" title="è¤‡è£½æ–¹æ¡ˆ">ğŸ“‹</button>
        <button onclick="deletePlan('${p.id}')" title="åˆªé™¤">ğŸ—‘</button>
      </div>
    </div>`;
  }).join('');
}

// === EDIT MODE ===
function toggleEditMode(){
  editMode=!editMode;
  const btn=document.getElementById('btnEdit');
  btn.classList.toggle('edit-active',editMode);
  btn.textContent=editMode?'âœ“':'âœï¸';
  document.getElementById('cards-panel').classList.toggle('edit-mode',editMode);
  renderItinerary();
}

// === EDIT PANEL ===
function openEditPanel(idx){
  editingIdx=idx;
  const itin=getActiveItinerary();
  const date=TRIP_DATES[currentDay];
  const items=itin[date]||[];
  const panel=document.getElementById('editPanel');
  if(idx>=0&&idx<items.length){
    const item=items[idx];
    document.getElementById('editPanelTitle').textContent='ç·¨è¼¯é …ç›®';
    document.getElementById('epName').value=item.name||'';
    document.getElementById('epTime').value=item.time||'';
    document.getElementById('epDuration').value=item.duration||'';
    document.getElementById('epType').value=item.type||'spot';
    document.getElementById('epIcon').value=item.icon||'';
    document.getElementById('epNote').value=item.note||'';
    document.getElementById('epPhone').value=item.phone||'';
    document.getElementById('epDrive').value=item.drive||'';
    document.getElementById('epTabelog').value=item.tabelog||'';
    editingCoords=item.coords?[...item.coords]:null;
    document.getElementById('epCoords').textContent=editingCoords?`${editingCoords[0]}, ${editingCoords[1]}`:'å°šæœªè¨­å®š';
  } else {
    document.getElementById('editPanelTitle').textContent='æ–°å¢é …ç›®';
    ['epName','epTime','epDuration','epIcon','epNote','epPhone','epDrive','epTabelog','epSearch'].forEach(id=>document.getElementById(id).value='');
    document.getElementById('epType').value='spot';
    editingCoords=null;
    document.getElementById('epCoords').textContent='å°šæœªè¨­å®š';
  }
  document.getElementById('epSearch').value='';
  document.getElementById('placesResults').classList.remove('show');
  panel.classList.add('open');
}
function closeEditPanel(){document.getElementById('editPanel').classList.remove('open')}

function saveEditItem(){
  const itin=getActiveItinerary();
  const date=TRIP_DATES[currentDay];
  if(!itin[date]) itin[date]=[];
  const typeIcons={spot:'ğŸ¯',restaurant:'ğŸ½',hotel:'ğŸ¨',transport:'ğŸš—',snack:'ğŸ¡',airport:'âœˆï¸'};
  const icon=document.getElementById('epIcon').value||typeIcons[document.getElementById('epType').value]||'ğŸ“';
  const item={
    time:document.getElementById('epTime').value||'00:00',
    name:document.getElementById('epName').value||'æœªå‘½å',
    type:document.getElementById('epType').value,
    icon,
    coords:editingCoords||[0,0],
    duration:document.getElementById('epDuration').value,
    note:document.getElementById('epNote').value,
  };
  const phone=document.getElementById('epPhone').value;
  if(phone) item.phone=phone;
  const drive=document.getElementById('epDrive').value;
  if(drive) item.drive=drive;
  const tabelog=document.getElementById('epTabelog').value;
  if(tabelog) item.tabelog=tabelog;

  if(editingIdx>=0&&editingIdx<itin[date].length){
    itin[date][editingIdx]=item;
  } else {
    itin[date].push(item);
  }
  updateActiveItinerary(itin);
  closeEditPanel();
  renderItinerary(); renderMap();
}

// === DELETE + UNDO ===
function deleteItem(idx){
  const itin=getActiveItinerary();
  const date=TRIP_DATES[currentDay];
  const items=itin[date]||[];
  if(idx<0||idx>=items.length) return;
  const removed=items.splice(idx,1)[0];
  updateActiveItinerary(itin);
  renderItinerary(); renderMap();
  showUndoToast(removed,idx,date);
}
function showUndoToast(item,idx,date){
  if(undoTimeout) clearTimeout(undoTimeout);
  const existing=document.querySelector('.toast');
  if(existing) existing.remove();
  undoItem={item,idx,date};
  const toast=document.createElement('div');
  toast.className='toast';
  toast.innerHTML=`å·²åˆªé™¤ã€Œ${item.name}ã€<button onclick="undoDelete()">å¾©åŸ</button>`;
  document.body.appendChild(toast);
  undoTimeout=setTimeout(()=>{toast.remove();undoItem=null},4000);
}
function undoDelete(){
  if(!undoItem) return;
  const itin=getActiveItinerary();
  if(!itin[undoItem.date]) itin[undoItem.date]=[];
  itin[undoItem.date].splice(undoItem.idx,0,undoItem.item);
  updateActiveItinerary(itin);
  renderItinerary(); renderMap();
  const toast=document.querySelector('.toast');
  if(toast) toast.remove();
  if(undoTimeout) clearTimeout(undoTimeout);
  undoItem=null;
}

// === DRAG & DROP ===
function onDragStart(e,idx){
  dragSrcIdx=idx;
  e.dataTransfer.effectAllowed='move';
  e.target.closest('.card').classList.add('dragging');
}
function onDragOver(e){
  e.preventDefault();e.dataTransfer.dropEffect='move';
  const card=e.target.closest('.card');
  document.querySelectorAll('.card.drag-over').forEach(c=>c.classList.remove('drag-over'));
  if(card) card.classList.add('drag-over');
}
function onDrop(e,idx){
  e.preventDefault();
  document.querySelectorAll('.card.drag-over').forEach(c=>c.classList.remove('drag-over'));
  if(dragSrcIdx===null||dragSrcIdx===idx) return;
  reorderItem(dragSrcIdx,idx);
  dragSrcIdx=null;
}
function onDragEnd(e){
  dragSrcIdx=null;
  document.querySelectorAll('.card.dragging,.card.drag-over').forEach(c=>{c.classList.remove('dragging');c.classList.remove('drag-over')});
}
function reorderItem(fromIdx,toIdx){
  const itin=getActiveItinerary();
  const date=TRIP_DATES[currentDay];
  const items=itin[date]||[];
  if(fromIdx<0||fromIdx>=items.length||toIdx<0||toIdx>=items.length) return;
  const [moved]=items.splice(fromIdx,1);
  items.splice(toIdx,0,moved);
  updateActiveItinerary(itin);
  renderItinerary(); renderMap();
}

// === TOUCH DRAG (mobile) ===
let touchDragIdx=null, touchClone=null, touchStartY=0;
function onTouchDragStart(e,idx){
  e.stopPropagation(); e.preventDefault();
  touchDragIdx=idx;
  const card=e.target.closest('.card');
  touchStartY=e.touches[0].clientY;
  touchClone=card.cloneNode(true);
  touchClone.style.cssText='position:fixed;left:0;right:0;z-index:999;opacity:.85;pointer-events:none;box-shadow:0 4px 20px rgba(0,0,0,.3);transition:none';
  touchClone.style.top=card.getBoundingClientRect().top+'px';
  document.body.appendChild(touchClone);
  card.classList.add('dragging');
  document.addEventListener('touchmove',onTouchDragMove,{passive:false});
  document.addEventListener('touchend',onTouchDragEnd);
}
function onTouchDragMove(e){
  e.preventDefault();
  if(touchClone){
    const dy=e.touches[0].clientY-touchStartY;
    const origCard=document.getElementById('card-'+touchDragIdx);
    if(origCard) touchClone.style.top=(origCard.getBoundingClientRect().top+dy)+'px';
  }
  // highlight drop target
  document.querySelectorAll('.card.drag-over').forEach(c=>c.classList.remove('drag-over'));
  const el=document.elementFromPoint(e.touches[0].clientX,e.touches[0].clientY);
  if(el){const card=el.closest('.card');if(card) card.classList.add('drag-over')}
}
function onTouchDragEnd(e){
  document.removeEventListener('touchmove',onTouchDragMove);
  document.removeEventListener('touchend',onTouchDragEnd);
  if(touchClone){touchClone.remove();touchClone=null}
  document.querySelectorAll('.card.dragging,.card.drag-over').forEach(c=>{c.classList.remove('dragging');c.classList.remove('drag-over')});
  // find drop target
  const touch=e.changedTouches[0];
  const el=document.elementFromPoint(touch.clientX,touch.clientY);
  if(el){
    const card=el.closest('.card');
    if(card&&card.id.startsWith('card-')){
      const toIdx=parseInt(card.id.split('-')[1]);
      if(touchDragIdx!==null&&touchDragIdx!==toIdx) reorderItem(touchDragIdx,toIdx);
    }
  }
  touchDragIdx=null;
}

// === PLACES SEARCH ===
function onPlacesSearch(q){
  clearTimeout(placesTimeout);
  const el=document.getElementById('placesResults');
  if(q.length<2){el.classList.remove('show');return}
  placesTimeout=setTimeout(()=>{
    fetch('/api/places/autocomplete?input='+encodeURIComponent(q))
      .then(r=>r.json()).then(data=>{
        const preds=data.predictions||[];
        if(!preds.length){el.classList.remove('show');return}
        el.innerHTML=preds.map(p=>`<li onclick="selectPlace('${p.place_id}','${p.description.replace(/'/g,"\\'")}')">ğŸ“ ${p.description}</li>`).join('');
        el.classList.add('show');
      }).catch(()=>el.classList.remove('show'));
  },300);
}
function selectPlace(placeId,desc){
  document.getElementById('placesResults').classList.remove('show');
  document.getElementById('epSearch').value=desc;
  fetch('/api/places/details?place_id='+placeId)
    .then(r=>r.json()).then(data=>{
      const r=data.result||{};
      if(r.name) document.getElementById('epName').value=r.name;
      if(r.formatted_phone_number) document.getElementById('epPhone').value=r.formatted_phone_number;
      if(r.geometry&&r.geometry.location){
        editingCoords=[r.geometry.location.lat,r.geometry.location.lng];
        document.getElementById('epCoords').textContent=`${editingCoords[0]}, ${editingCoords[1]}`;
      }
    }).catch(()=>{});
}

// === DISTANCE CALC ===
function autoCalcDistance(){
  const itin=getActiveItinerary();
  const date=TRIP_DATES[currentDay];
  const items=itin[date]||[];
  if(editingIdx<=0&&editingIdx!==-1){alert('ç¬¬ä¸€å€‹é …ç›®ç„¡æ³•è¨ˆç®—èˆ‡å‰ä¸€ç«™çš„è·é›¢');return}
  const prevIdx=editingIdx===-1?items.length-1:editingIdx-1;
  if(prevIdx<0||!items[prevIdx]||!items[prevIdx].coords){alert('å‰ä¸€ç«™æ²’æœ‰åº§æ¨™');return}
  const prevCoords=items[prevIdx].coords;
  const curCoords=editingCoords;
  if(!curCoords||curCoords[0]===0){alert('ç›®å‰é …ç›®æ²’æœ‰åº§æ¨™ï¼Œè«‹å…ˆæœå°‹åœ°é»');return}
  fetch('/api/distance',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({points:[prevCoords,curCoords]})})
    .then(r=>r.json()).then(data=>{
      if(data.distances&&data.distances[0]){
        const d=data.distances[0];
        document.getElementById('epDrive').value=`è»Šç¨‹ç´„${d.minutes}åˆ† (${d.straight_km}km)`;
      }
    }).catch(()=>alert('è·é›¢è¨ˆç®—å¤±æ•—'));
}

// === MAP SEARCH ===
function onMapSearch(q){
  clearTimeout(mapSearchTimeout);
  const el=document.getElementById('mapSearchResults');
  const clearBtn=document.getElementById('mapSearchClear');
  clearBtn.classList.toggle('show',q.length>0);
  if(q.length<2){el.classList.remove('show');return}
  mapSearchTimeout=setTimeout(()=>{
    fetch('/api/places/autocomplete?input='+encodeURIComponent(q))
      .then(r=>r.json()).then(data=>{
        const preds=data.predictions||[];
        if(!preds.length){el.classList.remove('show');return}
        el.innerHTML=preds.map(p=>`<li onclick="selectMapPlace('${p.place_id}')">ğŸ“ ${p.description}</li>`).join('');
        el.classList.add('show');
      }).catch(()=>el.classList.remove('show'));
  },300);
}

function selectMapPlace(placeId){
  const el=document.getElementById('mapSearchResults');
  el.classList.remove('show');
  fetch('/api/places/details?place_id='+placeId)
    .then(r=>r.json()).then(data=>{
      const r=data.result||{};
      if(!r.geometry||!r.geometry.location) return;
      const lat=r.geometry.location.lat, lng=r.geometry.location.lng;
      const name=r.name||'æœªçŸ¥åœ°é»';
      document.getElementById('mapSearchInput').value=name;
      document.getElementById('mapSearchClear').classList.add('show');
      mapSearchResult={name,lat,lng,phone:r.formatted_phone_number||'',address:r.formatted_address||''};
      // Remove old search marker
      if(mapSearchMarker){mapSearchMarker.map=null;mapSearchMarker=null}
      // Add red search marker
      mapSearchMarker=new google.maps.marker.AdvancedMarkerElement({
        map:googleMap,
        position:{lat,lng},
        content:createMarkerContent('ğŸ” '+name,'#f44336')
      });
      // InfoWindow
      let ph=`<div class="popup-title">ğŸ” ${name}</div>`;
      if(mapSearchResult.address) ph+=`<div style="font-size:11px;color:#666">${mapSearchResult.address}</div>`;
      if(mapSearchResult.phone) ph+=`<div style="font-size:11px">ğŸ“ ${mapSearchResult.phone}</div>`;
      ph+=`<a class="popup-nav-btn" href="${gmapSearchUrl(name)}" target="_blank">ğŸ“ Google Maps</a>`;
      ph+=` <button class="popup-add-btn" onclick="addSearchResultToItinerary()">+ åŠ å…¥è¡Œç¨‹</button>`;
      gInfoWindow.setContent(ph);
      gInfoWindow.open(googleMap,mapSearchMarker);
      googleMap.panTo({lat,lng});
      googleMap.setZoom(16);
    }).catch(()=>{});
}

function clearMapSearch(){
  document.getElementById('mapSearchInput').value='';
  document.getElementById('mapSearchClear').classList.remove('show');
  document.getElementById('mapSearchResults').classList.remove('show');
  if(mapSearchMarker){mapSearchMarker.map=null;mapSearchMarker=null}
  mapSearchResult=null;
}

function addSearchResultToItinerary(){
  if(!mapSearchResult) return;
  const r=mapSearchResult;
  const itin=getActiveItinerary();
  const date=TRIP_DATES[currentDay];
  const items=itin[date]||[];
  // Compute smart default time from last item
  let defaultTime='09:00';
  if(items.length){
    const last=items[items.length-1];
    const m=last.time.match(/^(\d{1,2}):(\d{2})$/);
    if(m){
      let mins=parseInt(m[1])*60+parseInt(m[2]);
      const durMatch=(last.duration||'').match(/(\d+)/);
      mins+=durMatch?parseInt(durMatch[1]):60;
      const h=Math.floor(mins/60), mi=mins%60;
      defaultTime=`${String(h).padStart(2,'0')}:${String(mi).padStart(2,'0')}`;
    }
  }
  openEditPanel(-1);
  document.getElementById('epName').value=r.name;
  document.getElementById('epTime').value=defaultTime;
  if(r.phone) document.getElementById('epPhone').value=r.phone;
  editingCoords=[r.lat,r.lng];
  document.getElementById('epCoords').textContent=`${r.lat}, ${r.lng}`;
  // Auto calc drive from previous item
  if(items.length){
    const prev=items[items.length-1];
    if(prev.coords&&prev.coords[0]>30){
      fetch('/api/distance',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({points:[prev.coords,[r.lat,r.lng]]})})
        .then(res=>res.json()).then(data=>{
          if(data.distances&&data.distances[0]){
            const d=data.distances[0];
            document.getElementById('epDrive').value=`è»Šç¨‹ç´„${d.minutes}åˆ† (${d.straight_km}km)`;
          }
        }).catch(()=>{});
    }
  }
  if(gInfoWindow) gInfoWindow.close();
}

// === HELPERS ===
function gmapNavUrl(lat,lng){return `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&travelmode=driving`}
function gmapSearchUrl(name,coords){const q=encodeURIComponent(name);if(coords&&coords[0]>30)return`https://www.google.com/maps/search/${q}/@${coords[0]},${coords[1]},17z`;return`https://www.google.com/maps/search/?api=1&query=${q}`}

// === LOAD GOOGLE MAPS API ===
function loadGoogleMapsApi(){
  return fetch('/api/config').then(r=>r.json()).then(cfg=>{
    return new Promise((resolve,reject)=>{
      if(window.google&&window.google.maps){resolve();return}
      const s=document.createElement('script');
      s.src=`https://maps.googleapis.com/maps/api/js?key=${cfg.googleMapsApiKey}&libraries=places,marker&loading=async&callback=__gmReady`;
      s.async=true;s.defer=true;
      window.__gmReady=()=>{delete window.__gmReady;resolve()};
      s.onerror=reject;
      document.head.appendChild(s);
    });
  });
}

// === INIT ===
function showFallbackBanner(){
  document.body.classList.add('fallback-mode');
}
async function init(){
  // Load from DB â€” distinguish error (DB broken) vs null (DB empty/first run)
  const safeFetch = url => fetch(url).then(async r=>{
    const data = await r.json();
    return r.ok ? data : {_dbError: true};
  }).catch(()=>({_dbError: true}));
  let dbFailed = false;
  try {
    const [plansRes, resRes, orderRes] = await Promise.all([
      safeFetch('/api/data/trip_plans'),
      safeFetch('/api/data/resStatus'),
      safeFetch('/api/data/resOrder')
    ]);
    if(plansRes && plansRes.plans){
      _plansCache=plansRes;
    } else if(plansRes && plansRes._dbError){
      _plansCache=defaultPlans();
      dbFailed=true;
    } else {
      // DB working but empty â†’ seed with defaults
      _plansCache=defaultPlans();
      fetch('/api/data/trip_plans',{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(_plansCache)}).catch(()=>{});
    }
    if(resRes && typeof resRes==='object' && !resRes._dbError){
      resStatusMap=resRes;
    } else if(!resRes || !resRes._dbError){
      if(!dbFailed) fetch('/api/data/resStatus',{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(resStatusMap)}).catch(()=>{});
    }
    resOrder=Array.isArray(orderRes)&&orderRes.length===reservations.length?orderRes:reservations.map((_,i)=>i);
  } catch(e){ dbFailed=true; }
  if(dbFailed) showFallbackBanner();
  const today=new Date().toISOString().slice(0,10);
  const idx=TRIP_DATES.indexOf(today);
  if(idx>=0) currentDay=idx;
  renderDayChips(); renderItinerary(); renderFoodPage(); renderReservations(); setupTabs();
  loadGoogleMapsApi().then(()=>setTimeout(initMap,100)).catch(e=>console.warn('Google Maps load failed',e));
  updateCountdown(); setInterval(updateCountdown,60000);
}

// === DAY CHIPS ===
function renderDayChips(){
  const el=document.getElementById('dayChips');
  let html=`<button class="day-chip${currentDay===-1?' active':''}" data-day="-1">ALL ç¸½è¦½</button>`;
  html+=TRIP_DATES.map((d,i)=>{
    const dt=new Date(d+'T12:00:00+09:00');
    const wd=['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][dt.getDay()];
    return `<button class="day-chip${i===currentDay?' active':''}" data-day="${i}">${DAY_SHORT[i]} ${dt.getMonth()+1}/${dt.getDate()}(${wd})</button>`;
  }).join('');
  el.innerHTML=html;
  el.querySelectorAll('.day-chip').forEach(b=>{
    b.onclick=()=>{
      currentDay=+b.dataset.day;
      document.querySelectorAll('.day-chip').forEach(c=>c.classList.toggle('active',+c.dataset.day===currentDay));
      clearMapSearch();
      renderItinerary(); renderMap();
    };
  });
}

// === MAP HELPERS ===
function createMarkerContent(label,color){
  const div=document.createElement('div');
  div.className='marker-label';
  div.style.background=color;
  div.textContent=label;
  return div;
}

// === MAP ===
function initMap(){
  if(googleMap) return;
  if(!window.google||!window.google.maps) return;
  googleMap=new google.maps.Map(document.getElementById('map-container'),{
    center:{lat:33.25,lng:130.1},zoom:9,
    mapId:'TRAVEL_MAP_MAIN',
    zoomControl:true,
    zoomControlOptions:{position:google.maps.ControlPosition.RIGHT_BOTTOM},
    streetViewControl:false,
    fullscreenControl:false
  });
  gInfoWindow=new google.maps.InfoWindow();

  // POI click
  googleMap.addListener('click',(e)=>{
    if(e.placeId){
      e.stop();
      handlePoiClick(e.placeId,e.latLng);
    }
  });

  renderMap();
}

const POI_TYPE_ZH={'restaurant':'é¤å»³','cafe':'å’–å•¡å»³','bar':'é…’å§','lodging':'ä½å®¿','park':'å…¬åœ’','museum':'åšç‰©é¤¨','shrine':'ç¥ç¤¾','temple':'å¯ºå»Ÿ','store':'å•†åº—','shopping_mall':'å•†å ´','convenience_store':'ä¾¿åˆ©åº—','train_station':'è»Šç«™','bus_station':'å…¬è»Šç«™','airport':'æ©Ÿå ´','pharmacy':'è—¥å±€','hospital':'é†«é™¢','bakery':'éºµåŒ…åº—','supermarket':'è¶…å¸‚','tourist_attraction':'è§€å…‰æ™¯é»','amusement_park':'éŠæ¨‚åœ’','aquarium':'æ°´æ—é¤¨','zoo':'å‹•ç‰©åœ’','spa':'æº«æ³‰','book_store':'æ›¸åº—','clothing_store':'æœé£¾åº—'};
function poiStars(n){return 'â˜…'.repeat(Math.round(n))+'â˜†'.repeat(5-Math.round(n));}
function poiPrice(l){return l?'Â·'+'$'.repeat(l):'';}

function handlePoiClick(placeId,latLng){
  fetch('/api/places/details?place_id='+placeId)
    .then(r=>r.json()).then(data=>{
      const r=data.result||{};
      const name=r.name||'æœªçŸ¥åœ°é»';
      const eName=name.replace(/'/g,"\\'");
      let h='<div class="poi-card">';

      // Photos
      if(r.photos&&r.photos.length){
        h+='<div class="poi-photos">';
        r.photos.slice(0,3).forEach(p=>{
          h+=`<img src="/api/places/photo?ref=${encodeURIComponent(p.photo_reference)}&w=300" alt="photo" loading="lazy">`;
        });
        h+='</div>';
      }

      // Name + rating
      h+=`<div class="popup-title">${name}</div>`;
      if(r.rating){
        h+=`<div class="poi-meta"><span style="color:#fbbc04">${poiStars(r.rating)}</span> ${r.rating}`;
        if(r.user_ratings_total) h+=` (${r.user_ratings_total})`;
        h+=` ${poiPrice(r.price_level)}</div>`;
      }

      // Type tags
      if(r.types&&r.types.length){
        const tags=r.types.filter(t=>POI_TYPE_ZH[t]).slice(0,4);
        if(tags.length){
          h+='<div class="poi-tags">';
          tags.forEach(t=>{h+=`<span>${POI_TYPE_ZH[t]}</span>`;});
          h+='</div>';
        }
      }

      // Address
      if(r.formatted_address) h+=`<div class="poi-meta">${r.formatted_address}</div>`;

      // Opening hours
      if(r.opening_hours){
        const oh=r.opening_hours;
        const today=new Date().getDay();
        const todayText=oh.weekday_text&&oh.weekday_text[today===0?6:today-1];
        h+=`<div class="poi-meta">${oh.open_now?'<b style="color:#0d8043">å–¶æ¥­ä¸­</b>':'<b style="color:#d93025">å–¶æ¥­æ™‚é–“å¤–</b>'}`;
        if(oh.weekday_text){
          h+=` <button class="poi-hours-toggle" onclick="this.nextElementSibling.classList.toggle('open')">æ™‚é–“ã‚’è¡¨ç¤º</button>`;
          h+=`<div class="poi-hours-full">${oh.weekday_text.join('\n')}</div>`;
        }
        h+='</div>';
      }

      // Phone + website
      if(r.formatted_phone_number) h+=`<div class="poi-meta">ğŸ“ ${r.formatted_phone_number}</div>`;
      if(r.website) h+=`<div class="poi-meta"><a href="${r.website}" target="_blank" style="color:#1a73e8">ğŸŒ ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆ</a></div>`;

      // Reviews
      if(r.reviews&&r.reviews.length){
        r.reviews.slice(0,2).forEach(rv=>{
          h+=`<div class="poi-review"><span class="author">${rv.author_name||''}</span> <span class="stars">${poiStars(rv.rating)}</span><div class="text">${rv.text||''}</div></div>`;
        });
      }

      // Actions
      h+=`<div class="poi-actions">`;
      h+=`<a class="popup-nav-btn" href="${gmapSearchUrl(name)}" target="_blank">ğŸ“ Google Maps</a>`;
      h+=` <button class="popup-add-btn" onclick="addPoiToItinerary('${eName}',${latLng.lat()},${latLng.lng()},'${(r.formatted_phone_number||'').replace(/'/g,"\\'")}')">+ åŠ å…¥è¡Œç¨‹</button>`;
      h+='</div></div>';

      gInfoWindow.setContent(h);
      gInfoWindow.setPosition(latLng);
      gInfoWindow.open(googleMap);
    }).catch(()=>{});
}

function addPoiToItinerary(name,lat,lng,phone){
  const itin=getActiveItinerary();
  const date=TRIP_DATES[currentDay<0?0:currentDay];
  const items=itin[date]||[];
  let defaultTime='09:00';
  if(items.length){
    const last=items[items.length-1];
    const m=last.time.match(/^(\d{1,2}):(\d{2})$/);
    if(m){
      let mins=parseInt(m[1])*60+parseInt(m[2]);
      const durMatch=(last.duration||'').match(/(\d+)/);
      mins+=durMatch?parseInt(durMatch[1]):60;
      const h=Math.floor(mins/60),mi=mins%60;
      defaultTime=`${String(h).padStart(2,'0')}:${String(mi).padStart(2,'0')}`;
    }
  }
  if(currentDay<0) currentDay=0;
  openEditPanel(-1);
  document.getElementById('epName').value=name;
  document.getElementById('epTime').value=defaultTime;
  if(phone) document.getElementById('epPhone').value=phone;
  editingCoords=[lat,lng];
  document.getElementById('epCoords').textContent=`${lat}, ${lng}`;
  gInfoWindow.close();
}

function renderMap(){
  if(!googleMap) return;
  mapMarkers.forEach(m=>m.map=null);
  mapLines.forEach(l=>l.setMap(null));
  mapMarkers=[];mapLines=[];
  if(currentDay===-1){ renderOverallMap(); return; }
  const date=TRIP_DATES[currentDay], itin=getActiveItinerary(), allItems=itin[date]||[];
  const items=allItems.filter(i=>i.coords&&i.coords[0]>30);
  if(!items.length) return;
  const colors={spot:'#4caf50',restaurant:'#ff9800',hotel:'#e91e63',snack:'#ffc107',airport:'#607d8b',transport:'#2196f3'};
  const bounds=new google.maps.LatLngBounds();
  items.forEach((item,idx)=>{
    const origIdx=allItems.indexOf(item);
    const color=colors[item.type]||'#999';
    const marker=new google.maps.marker.AdvancedMarkerElement({
      map:googleMap,
      position:{lat:item.coords[0],lng:item.coords[1]},
      content:createMarkerContent(`${idx+1}. ${item.icon} ${item.name}`,color)
    });
    let ph=`<div class="popup-title">${item.icon} ${item.name}</div>`;
    ph+=`<div>${item.time}${item.duration?' ãƒ» '+item.duration:''}</div>`;
    if(item.note) ph+=`<div style="margin-top:3px;font-size:11px;color:#666;white-space:pre-line">${item.note.split('\n').slice(0,2).join('\n')}</div>`;
    ph+=`<a class="popup-nav-btn" href="${gmapSearchUrl(item.gmap||item.name,item.coords)}" target="_blank">ğŸ“ Google Maps</a>`;
    if(item.phone) ph+=` <a class="popup-call-btn" href="tel:${item.phone}">ğŸ“ æ’¥æ‰“</a>`;
    marker.addListener('gmp-click',()=>{
      gInfoWindow.setContent(ph);
      gInfoWindow.open(googleMap,marker);
      highlightCard(origIdx);
    });
    mapMarkers.push(marker);
    bounds.extend({lat:item.coords[0],lng:item.coords[1]});
  });
  if(items.length>1){
    const path=items.map(i=>({lat:i.coords[0],lng:i.coords[1]}));
    const line=new google.maps.Polyline({path,strokeColor:'#e91e63',strokeWeight:2.5,strokeOpacity:.4,map:googleMap});
    mapLines.push(line);
  }
  googleMap.fitBounds(bounds,30);
}

function renderOverallMap(){
  const dayColors=['#e91e63','#ff9800','#4caf50','#2196f3','#9c27b0','#607d8b'];
  const itin=getActiveItinerary();
  const allBounds=new google.maps.LatLngBounds();
  let hasBounds=false;
  TRIP_DATES.forEach((date,di)=>{
    const items=(itin[date]||[]).filter(i=>i.coords&&i.coords[0]>30);
    if(!items.length) return;
    const color=dayColors[di]||'#999';
    const routePath=[];
    items.forEach(item=>{
      const marker=new google.maps.marker.AdvancedMarkerElement({
        map:googleMap,
        position:{lat:item.coords[0],lng:item.coords[1]},
        content:createMarkerContent(`${DAY_SHORT[di]} ${item.icon} ${item.name}`,color)
      });
      let ph=`<div class="popup-title">${item.icon} ${item.name}</div>`;
      ph+=`<div>${DAY_SHORT[di]} ${item.time}${item.duration?' ãƒ» '+item.duration:''}</div>`;
      ph+=`<a class="popup-nav-btn" href="${gmapSearchUrl(item.gmap||item.name,item.coords)}" target="_blank">ğŸ“ Google Maps</a>`;
      marker.addListener('gmp-click',()=>{
        gInfoWindow.setContent(ph);
        gInfoWindow.open(googleMap,marker);
      });
      mapMarkers.push(marker);
      const pos={lat:item.coords[0],lng:item.coords[1]};
      routePath.push(pos);
      allBounds.extend(pos);
      hasBounds=true;
    });
    if(routePath.length>1){
      const line=new google.maps.Polyline({path:routePath,strokeColor:color,strokeWeight:3,strokeOpacity:.6,map:googleMap});
      mapLines.push(line);
    }
  });
  if(hasBounds) googleMap.fitBounds(allBounds,30);
}

function highlightCard(idx){
  document.querySelectorAll('.card').forEach(c=>c.classList.remove('highlight'));
  const card=document.getElementById('card-'+idx);
  if(card){
    card.classList.add('highlight');
    card.scrollIntoView({behavior:'smooth',block:'center'});
    const d=document.getElementById('detail-'+idx);
    if(d&&!d.classList.contains('open')) d.classList.add('open');
    setTimeout(()=>card.classList.remove('highlight'),3000);
  }
}
function focusMap(lat,lng){
  if(!googleMap) return;
  googleMap.panTo({lat,lng});
  googleMap.setZoom(14);
  const itin=getActiveItinerary();
  const items=(itin[TRIP_DATES[currentDay]]||[]).filter(i=>i.coords&&i.coords[0]>30);
  const mi=items.findIndex(i=>i.coords[0]===lat&&i.coords[1]===lng);
  if(mi>=0&&mapMarkers[mi]){
    google.maps.event.trigger(mapMarkers[mi],'click');
  }
}

// === ITINERARY CARDS ===
function updatePlanLabel(){const l=document.getElementById('activePlanLabel');if(l)l.textContent='ğŸ“‹ '+getActivePlan().name}
function renderItinerary(){
  updatePlanLabel();
  const panel=document.getElementById('cards-panel');
  panel.classList.toggle('edit-mode',editMode);
  if(currentDay===-1){ renderOverallCards(panel); return; }
  const date=TRIP_DATES[currentDay], itin=getActiveItinerary(), items=itin[date]||[];
  const now=getNowJST(),isToday=now.dateStr===date;
  let html='';
  if(isToday){
    html+=`<div id="nowIndicator" class="now-indicator" style="display:none"></div>`;
    html+=`<div id="countdownBar" class="countdown-bar" style="display:none"></div>`;
  }
  html+=`<div class="section-title">${DAY_LABELS[currentDay]} â€” ${DAY_REGIONS[currentDay]}</div>`;
  let mapIdx=0;
  items.forEach((item,idx)=>{
    const hasMap=item.coords&&item.coords[0]>30;
    if(hasMap) mapIdx++;
    const isNow=isToday&&isCurrentItem(items,idx,now.timeMin);
    {
      const driveMin=extractMins(item.drive);
      let dInfo=item.drive?`ğŸš— ${item.drive}`:'';
      if(idx>0){
        const prev=items[idx-1];
        if(prev.duration){
          const expMin=parseTime(prev.time)+extractMins(prev.duration)+driveMin;
          const actMin=parseTime(item.time);
          const gap=actMin-expMin;
          const eh=Math.floor(expMin/60)%24,em=expMin%60;
          const expStr=`${eh}:${String(em).padStart(2,'0')}`;
          const [gapStr,gapColor]=gap===0?['âœ“ å‰›å¥½','#43a047']:gap>0?[`+${gap}åˆ†`,gap<=15?'#ff9800':'#9e9e9e']:[`${gap}åˆ† âš ï¸`,'#e53935'];
          dInfo+=(dInfo?' Â· ':'')+`é è¨ˆ ${expStr}â†’ä½ å¡« ${item.time} <span style="color:${gapColor};font-weight:600">${gapStr}</span>`;
        }
      }
      if(dInfo) html+=`<div class="drive-info">${dInfo}</div>`;
    }
    html+=`<div class="card${isNow?' now':''}" id="card-${idx}" draggable="true" ondragstart="onDragStart(event,${idx})" ondragover="onDragOver(event)" ondrop="onDrop(event,${idx})" ondragend="onDragEnd(event)">`;
    html+=`<div class="card-main" onclick="onCardClick(${idx})">`;
    html+=`<span class="card-drag-handle" ontouchstart="onTouchDragStart(event,${idx})" title="æ‹–æ›³æ’åº">â ¿</span>`;
    html+=`<div class="card-time">${item.time}</div><div class="card-icon ${item.type}">${item.icon}</div>`;
    const numTag=hasMap?`<span style="color:var(--text2);font-size:11px;margin-right:4px">${mapIdx}.</span>`:'';
    html+=`<div class="card-info"><div class="card-name">${numTag}${item.name}</div>`;
    {const nd=['spot','restaurant','snack'].includes(item.type);const ds=item.duration?`â±${item.duration}`:nd?`<span style="color:#ff9800;font-weight:600">â± æœªå¡«</span>`:'';html+=`<div class="card-sub">${ds}${ds&&item.type?' Â· ':''}${getTypeLabel(item.type)}</div></div>`;}
    html+=`<div class="card-arrow">â€º</div></div>`;
    if(item.note||item.phone||item.tabelog||item.coords){
      html+=`<div class="card-detail" id="detail-${idx}">`;
      if(item.note) html+=`<div style="white-space:pre-line;font-size:12px;color:var(--text2);padding:4px 0;line-height:1.6">${item.note}</div>`;
      html+=`<div class="card-actions">`;
      if(item.coords&&item.coords[0]>30) html+=`<a class="btn btn-nav" href="${gmapSearchUrl(item.gmap||item.name,item.coords)}" target="_blank" onclick="event.stopPropagation()">ğŸ“ Google Maps</a>`;
      if(item.phone) html+=`<a class="btn btn-call" href="tel:${item.phone}" onclick="event.stopPropagation()">ğŸ“ ${item.phone}</a>`;
      if(item.tabelog) html+=`<a class="btn btn-link" href="${item.tabelog}" target="_blank" onclick="event.stopPropagation()">â­ Tabelog</a>`;
      html+=`</div></div>`;
    }
    // Edit bar (visible in edit mode)
    html+=`<div class="edit-bar">`;
    html+=`<span class="drag-handle" title="æ‹–æ›³æ’åº">â ¿</span>`;
    html+=`<button class="btn btn-edit" onclick="event.stopPropagation();openEditPanel(${idx})">âœï¸ ç·¨è¼¯</button>`;
    html+=`<button class="btn btn-del" onclick="event.stopPropagation();deleteItem(${idx})">ğŸ—‘ åˆªé™¤</button>`;
    html+=`</div>`;
    html+=`</div>`;
  });
  html+=`<button class="add-item-btn" onclick="openEditPanel(-1)">+ æ–°å¢åœ°é»</button>`;
  const tips=DAY_TIPS[date]||[];
  if(tips.length){
    html+=`<div style="margin:16px 0 8px;padding:10px 12px;background:var(--card);border-radius:12px;border-left:3px solid #ff9800">`;
    html+=`<div style="font-weight:700;font-size:13px;margin-bottom:6px">âš ï¸ æ³¨æ„äº‹é …</div>`;
    tips.forEach(t=>html+=`<div style="font-size:12px;color:var(--text2);line-height:1.7;padding-left:8px">â€¢ ${t}</div>`);
    html+=`</div>`;
  }
  panel.innerHTML=html;
  if(isToday){updateCountdown();const nc=panel.querySelector('.card.now');if(nc) setTimeout(()=>nc.scrollIntoView({behavior:'smooth',block:'center'}),300);}
}

function renderOverallCards(panel){
  const dayColors=['#e91e63','#ff9800','#4caf50','#2196f3','#9c27b0','#607d8b'];
  const itin=getActiveItinerary();
  let html='<div class="section-title">ğŸ—ºï¸ å…¨è¡Œç¨‹ç¸½è¦½ â€” 6å¤©5å¤œ</div>';
  TRIP_DATES.forEach((date,di)=>{
    const items=(itin[date]||[]).filter(i=>i.coords&&i.coords[0]>30&&i.type!=='transport');
    if(!items.length) return;
    const color=dayColors[di];
    html+=`<div style="margin:12px 0 6px;font-weight:700;font-size:13px;color:${color}">${DAY_SHORT[di]} ${DAY_LABELS[di]}</div>`;
    items.forEach(item=>{
      html+=`<div style="display:flex;align-items:center;gap:8px;padding:6px 8px;margin:2px 0;background:var(--card);border-radius:8px;border-left:3px solid ${color};font-size:12px;cursor:pointer" onclick="currentDay=${di};document.querySelectorAll('.day-chip').forEach(c=>c.classList.toggle('active',+c.dataset.day===${di}));renderItinerary();renderMap()">`;
      html+=`<span>${item.icon}</span><span style="flex:1">${item.name}</span><span style="color:var(--text2);font-size:11px">${item.time}</span>`;
      html+=`</div>`;
    });
  });
  panel.innerHTML=html;
}

function onCardClick(idx){
  const d=document.getElementById('detail-'+idx);
  if(d) d.classList.toggle('open');
  const itin=getActiveItinerary();
  const item=(itin[TRIP_DATES[currentDay]]||[])[idx];
  if(item&&item.coords&&item.coords[0]>30) focusMap(item.coords[0],item.coords[1]);
}
function getTypeLabel(t){return{spot:'æ™¯é»',restaurant:'é¤å»³',hotel:'ä½å®¿',transport:'äº¤é€š',snack:'å°åƒ',airport:'æ©Ÿå ´'}[t]||''}
function getNowJST(){const n=new Date(),j=new Date(n.getTime()+(n.getTimezoneOffset()+540)*60000);return{dateStr:j.toISOString().slice(0,10),timeMin:j.getHours()*60+j.getMinutes()}}
function parseTime(t){const[h,m]=t.split(':').map(Number);return h*60+m}
function extractMins(s){const m=(s||'').match(/(\d+)/);return m?+m[1]:0}
function isCurrentItem(items,idx,nowMin){const s=parseTime(items[idx].time),e=idx<items.length-1?parseTime(items[idx+1].time):s+120;return nowMin>=s&&nowMin<e}

// === COUNTDOWN ===
function updateCountdown(){
  const bar=document.getElementById('countdownBar'),ind=document.getElementById('nowIndicator');
  if(!bar||!ind) return;
  const now=getNowJST(),date=TRIP_DATES[currentDay],itin=getActiveItinerary(),items=itin[date]||[];
  if(now.dateStr!==date){bar.style.display='none';ind.style.display='none';return}
  let ci=-1;for(let i=items.length-1;i>=0;i--)if(now.timeMin>=parseTime(items[i].time)){ci=i;break}
  if(ci>=0){ind.style.display='block';ind.innerHTML=`ğŸ“ ç›®å‰ï¼š${items[ci].name}`}
  if(ci>=0&&ci<items.length-1){const nx=items[ci+1],diff=parseTime(nx.time)-now.timeMin;if(diff>0&&diff<=180){bar.style.display='flex';bar.innerHTML=`â³ ä¸‹ä¸€ç«™ <b>${nx.name}</b>ã€€${diff}åˆ†é˜å¾Œ (${nx.time})`}else bar.style.display='none'}else bar.style.display='none';
}

// === FOOD PAGE ===
function renderFoodPage(){
  const s=document.getElementById('food-cards-panel');
  let h='<div class="section-title">ä½è³€ç‰¹è‰²ç¾é£Ÿ â€” æ—¥æ–‡åå¯ç›´æ¥çµ¦åº—å“¡çœ‹</div>';
  foods.forEach((f,i)=>{
    h+=`<div class="food-card" id="food-card-${i}" onclick="onFoodCardClick(${i})" style="cursor:pointer"><div class="food-name">${f.name}</div><div class="food-jp">ğŸ‡¯ğŸ‡µ ${f.jp}</div>`;
    h+=`<div class="food-desc">${f.desc}</div><div><span class="food-tag day">${f.day}</span><span class="food-tag price">${f.price}</span><span class="food-tag rating">æ¨è–¦ ${f.rating}</span></div>`;
    h+=`<div style="font-size:11px;color:var(--text2);margin-top:4px">ğŸ“ ${f.where}`;
    if(f.coords) h+=` <a class="btn btn-nav" href="${gmapSearchUrl(f.gmap||f.name,f.coords)}" target="_blank" onclick="event.stopPropagation()" style="margin-left:4px">ğŸ“ Google Maps</a>`;
    h+=`</div></div>`;
  });
  h+='<div class="section-title">ğŸŸ å­£ç¯€æµ·é®®æŒ‡å—</div>';
  h+='<div class="food-card"><div class="food-name">2/27 å”æ´¥ãƒ»å‘¼å­ çƒè³Šå­£</div><div class="food-desc" style="line-height:1.8">ğŸ¦‘ <b>ãƒ¤ãƒªã‚¤ã‚«</b>ï¼ˆæ§çƒè³Šï¼‰â€” 1~3æœˆæ—ºå­£ï¼Œé€æ˜è„†å½ˆ<br>ğŸ¦‘ <b>ã‚¢ã‚ªãƒªã‚¤ã‚«</b>ï¼ˆå†¬çƒè³Šï¼‰â€” 11~3æœˆé™å®šï¼Œåšå¯¦ç”˜ç”œ<br>ğŸ¦‘ <b>ã‚³ã‚¦ã‚¤ã‚«</b>ï¼ˆå¢¨çƒè³Šï¼‰â€” 2~4æœˆï¼Œæœ€ç”œ</div></div>';
  h+='<div class="food-card"><div class="food-name">3/2 å¤ªè‰¯ãƒ»é¹¿å³¶ æœ‰æ˜æµ·</div><div class="food-desc" style="line-height:1.8">ğŸ¦ª <b>ç«¹å´ç‰¡è £</b> â€” 11~3æœˆï¼ˆ2æœˆæœ€è‚¥ï¼‰å¤§é¡†é®®ç”œ<br>ğŸ¦€ <b>ç«¹å´èŸ¹ ãƒ¡ã‚¹ã‚¬ãƒ‹</b>ï¼ˆæ¯èŸ¹ï¼‰â€” 3æœˆæœ‰å…§å­ï¼ˆèŸ¹åµï¼‰<br>ğŸŸ <b>ãƒ ãƒ„ã‚´ãƒ­ã‚¦</b>ï¼ˆå½ˆå¡—é­šï¼‰â€” æœ‰æ˜æµ·ç‰¹ç”¢ï¼Œè’²ç‡’é¢¨å‘³</div></div>';
  s.innerHTML=h;
}

function initFoodMap(){
  if(foodMap) return;
  if(!window.google||!window.google.maps) return;
  foodMap=new google.maps.Map(document.getElementById('food-map-container'),{
    center:{lat:33.25,lng:130.1},zoom:9,
    mapId:'TRAVEL_MAP_FOOD',
    zoomControl:true,
    zoomControlOptions:{position:google.maps.ControlPosition.RIGHT_BOTTOM},
    streetViewControl:false,
    fullscreenControl:false
  });
  foodInfoWindow=new google.maps.InfoWindow();
  const colors={Day1:'#e91e63',Day2:'#ff9800',Day3:'#4caf50',Day4:'#2196f3',Day5:'#9c27b0'};
  const bounds=new google.maps.LatLngBounds();
  let hasBounds=false;
  foods.forEach((f,i)=>{
    if(!f.coords) return;
    const color=colors[f.day]||'#999';
    const marker=new google.maps.marker.AdvancedMarkerElement({
      map:foodMap,
      position:{lat:f.coords[0],lng:f.coords[1]},
      content:createMarkerContent(`${i+1}. ğŸ½ ${f.name}`,color)
    });
    let ph=`<div class="popup-title">ğŸ½ ${f.name}</div>`;
    ph+=`<div>${f.day} ãƒ» ${f.where}</div>`;
    ph+=`<div style="margin-top:3px;font-size:11px;color:#666">${f.jp}</div>`;
    ph+=`<a class="popup-nav-btn" href="${gmapSearchUrl(f.gmap||f.name,f.coords)}" target="_blank">ğŸ“ Google Maps</a>`;
    marker.addListener('gmp-click',()=>{
      foodInfoWindow.setContent(ph);
      foodInfoWindow.open(foodMap,marker);
      highlightFoodCard(i);
    });
    foodMarkers.push(marker);
    bounds.extend({lat:f.coords[0],lng:f.coords[1]});
    hasBounds=true;
  });
  if(hasBounds) foodMap.fitBounds(bounds,30);
}

function onFoodCardClick(idx){
  const f=foods[idx];
  if(!f||!f.coords||!foodMap) return;
  foodMap.panTo({lat:f.coords[0],lng:f.coords[1]});
  foodMap.setZoom(14);
  if(foodMarkers[idx]) google.maps.event.trigger(foodMarkers[idx],'click');
}

function highlightFoodCard(idx){
  document.querySelectorAll('#food-cards-panel .food-card').forEach(c=>c.classList.remove('highlight'));
  const card=document.getElementById('food-card-'+idx);
  if(card){
    card.classList.add('highlight');
    card.scrollIntoView({behavior:'smooth',block:'center'});
    setTimeout(()=>card.classList.remove('highlight'),3000);
  }
}

// === RESERVATIONS ===
function _buildResGroups(){
  if(!resOrder.length) resOrder=reservations.map((_,i)=>i);
  const groups=[];
  resOrder.forEach(i=>{
    const r=reservations[i], k=r.date+'|'+r.time;
    const g=groups.find(g=>g.key===k);
    if(g) g.items.push({r,i}); else groups.push({key:k,items:[{r,i}]});
  });
  return groups;
}
function renderReservations(){
  const s=document.getElementById('resScroll');
  let h='<div class="section-title">é ç´„äººï¼šWu Tsung Hsuan ãƒ» +886-981053092</div>';
  const altLabels=['A','B','C','D','E'];
  _buildResGroups().forEach(g=>{
    const isGroup=g.items.length>1;
    if(isGroup){
      const {r}=g.items[0];
      h+=`<div class="res-group"><div class="res-group-header">ğŸ“… ${r.date} ${r.time} &nbsp;Â·&nbsp; å‚™é¸æ–¹æ¡ˆï¼ˆæ‹–æ›³å¯èª¿æ•´é †åºï¼‰</div>`;
    }
    g.items.forEach(({r,i},gi)=>{
      const cf=resStatusMap[i];
      const isRejected=cf==='x', isConfirmed=cf===true, isWalkin=cf==='w';
      const statusCls=isConfirmed?' confirmed':isRejected?' rejected':isWalkin?' walkin':'';
      const statusLabel=isConfirmed?'âœ… å·²ç¢ºèª':isRejected?'âŒ ç„¡æ³•é ç´„':isWalkin?'ğŸš¶ ç¾å ´æ’':'â¬œ å¾…ç¢ºèª';
      const badge=isGroup?`<span class="res-alt-badge">${altLabels[gi]}</span>`:'';
      const dragAttrs=isGroup?`draggable="true" ondragstart="resDragStart(event,${i})" ondragover="resDragOver(event)" ondrop="resDrop(event,${i})" ondragleave="resDragLeave(event)" ondragend="resDragEnd(event)"`:'';
      const handle=isGroup?`<span class="res-drag-handle">â ¿</span>`:'';
      h+=`<div class="res-card${isRejected?' rejected':''}" ${dragAttrs}><div class="res-header"><div><div class="res-name">${handle}${badge}${r.zh||r.name}</div><div style="font-size:11px;color:var(--text2);margin-top:2px">${r.name}</div></div>`;
      if(!isGroup) h+=`<div class="res-date">${r.date} ${r.time}</div>`;
      h+=`</div><div class="res-info">ğŸ½ ${r.cuisine}<br>ğŸ’° ${r.price}<br>ğŸ‘¥ ${r.pax}<br>ğŸ“ ${r.note.replace(/\n/g,'<br>')}</div>`;
      h+=`<div class="res-actions"><a class="btn btn-call" href="tel:${r.phone}">ğŸ“ ${r.phone}</a>`;
      if(r.coords) h+=`<a class="btn btn-nav" href="${gmapSearchUrl(r.name,r.coords)}" target="_blank">ğŸ“ Google Maps</a>`;
      if(r.tabelog) h+=`<a class="btn btn-link" href="${r.tabelog}" target="_blank">â­ Tabelog</a>`;
      h+=`<button class="res-status${statusCls}" onclick="toggleResStatus(${i})">${statusLabel}</button></div></div>`;
    });
    if(isGroup) h+=`</div>`;
  });
  s.innerHTML=h;
}
let _dragSrc=null;
function resDragStart(e,i){_dragSrc=i;setTimeout(()=>e.target.classList.add('dragging'),0);}
function resDragOver(e){e.preventDefault();e.currentTarget.classList.add('drag-over');}
function resDragLeave(e){e.currentTarget.classList.remove('drag-over');}
function resDragEnd(e){_dragSrc=null;document.querySelectorAll('.res-card').forEach(c=>c.classList.remove('dragging','drag-over'));}
function resDrop(e,targetI){
  e.preventDefault();
  e.currentTarget.classList.remove('drag-over');
  if(_dragSrc===null||_dragSrc===targetI) return;
  const sr=reservations[_dragSrc], tr=reservations[targetI];
  if(sr.date+'|'+sr.time!==tr.date+'|'+tr.time) return;
  const sp=resOrder.indexOf(_dragSrc), tp=resOrder.indexOf(targetI);
  [resOrder[sp],resOrder[tp]]=[resOrder[tp],resOrder[sp]];
  fetch('/api/data/resOrder',{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(resOrder)}).catch(()=>{});
  renderReservations();
}
function copyVisaFormat(){
  let num=0;
  const parts=[];
  _buildResGroups().forEach(g=>{
    const pending=g.items.filter(({i})=>resStatusMap[i]!=='x'&&resStatusMap[i]!==true&&resStatusMap[i]!=='w');
    if(!pending.length) return;
    if(g.items.length>1&&pending.length>1){const dateOnly=pending[0].r.date.replace(/\s*[\(ï¼ˆ].*?[\)ï¼‰]/,'').trim();parts.push(`ã€${dateOnly} ${pending[0].r.time.replace(' åˆé¤','').replace(' æ™šé¤','')} æœ‰ ${pending.length} é–“å‚™é¸é¤å»³ï¼Œè«‹ä¾åºé€²è¡Œè¨‚ä½ï¼ã€‘`);}
    pending.forEach(({r})=>{
      const dateOnly=r.date.replace(/\s*[\(ï¼ˆ].*?[\)ï¼‰]/,'').trim();
      parts.push([`${++num}`,`  ${r.name}`,`  ${r.phone}`,`  é ç´„æ—¥æœŸ: ${dateOnly}`,`  é ç´„æ™‚é–“: ${r.time.replace(' åˆé¤','').replace(' æ™šé¤','')}`,`  é ç´„äººæ•¸: ${r.pax}`,`  åº§ä½: ç¦è¸`,`  é ç´„å¤§å: Wu Tsung Hsuan`,`  é ç´„é›»è©±: +886-981053092`].join('\n'));
    });
  });
  const text=parts.join('\n\n');
  navigator.clipboard.writeText(text).then(()=>{
    showToastMsg('âœ… å·²è¤‡è£½ visa æ ¼å¼åˆ°å‰ªè²¼ç°¿');
  }).catch(()=>{
    const ta=document.createElement('textarea');
    ta.value=text;document.body.appendChild(ta);ta.select();document.execCommand('copy');document.body.removeChild(ta);
    showToastMsg('âœ… å·²è¤‡è£½ visa æ ¼å¼åˆ°å‰ªè²¼ç°¿');
  });
}
function toggleResStatus(i){
  const cur=resStatusMap[i];
  resStatusMap[i]=cur===undefined||cur===null||cur===false?true:cur===true?'x':cur==='x'?'w':undefined;
  fetch('/api/data/resStatus',{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(resStatusMap)}).catch(()=>{});
  renderReservations();
}

// === TABS ===
function setupTabs(){
  document.querySelectorAll('.tab-item').forEach(tab=>{
    tab.onclick=()=>{
      const page=tab.dataset.page;if(page===currentPage) return;
      currentPage=page;
      document.querySelectorAll('.tab-item').forEach(t=>t.classList.toggle('active',t===tab));
      document.querySelectorAll('.page').forEach(p=>p.classList.toggle('active',p.id===page));
      if(page==='itinerary-page'&&googleMap) setTimeout(()=>{google.maps.event.trigger(googleMap,'resize');renderMap()},100);
      if(page==='food-page') setTimeout(()=>{if(!foodMap) initFoodMap(); else google.maps.event.trigger(foodMap,'resize');},100);
    };
  });
}

// === SERVICE WORKER (unregister + clear cache) ===
if('serviceWorker' in navigator){
  navigator.serviceWorker.getRegistrations().then(regs=>regs.forEach(r=>r.unregister()));
  caches.keys().then(ks=>ks.forEach(k=>caches.delete(k)));
}
const mf={name:'2026 ä½è³€æ—…è¡Œ',short_name:'ä½è³€æ—…è¡Œ',start_url:'.',display:'standalone',background_color:'#f5f5f5',theme_color:'#e91e63',icons:[{src:'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxODAgMTgwIj48cmVjdCB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgcng9IjQwIiBmaWxsPSIjZTkxZTYzIi8+PHRleHQgeD0iOTAiIHk9IjEwNSIgZm9udC1zaXplPSI4MCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0id2hpdGUiPuS9kOizgDwvdGV4dD48dGV4dCB4PSI5MCIgeT0iMTQ1IiBmb250LXNpemU9IjMwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSIjZmZjY2JjIj7ml4XooYwgMjAyNjwvdGV4dD48L3N2Zz4=',sizes:'180x180',type:'image/svg+xml'}]};
const ml=document.createElement('link');ml.rel='manifest';ml.href=URL.createObjectURL(new Blob([JSON.stringify(mf)],{type:'application/json'}));document.head.appendChild(ml);

// === EXPORT / IMPORT ===
function exportItinerary(){
  const plan=getActivePlan();
  const json=JSON.stringify(plan.data,null,2);
  navigator.clipboard.writeText(json).then(()=>{
    showToastMsg('âœ… å·²è¤‡è£½ã€Œ'+plan.name+'ã€è¡Œç¨‹ JSON åˆ°å‰ªè²¼ç°¿');
  }).catch(()=>{
    // fallback: show in modal
    openImportModalWith(json,true);
  });
}
function showToastMsg(msg){
  const t=document.createElement('div');t.className='toast';t.textContent=msg;
  document.body.appendChild(t);setTimeout(()=>t.remove(),2500);
}
function openImportModal(){
  let overlay=document.getElementById('importModal');
  if(!overlay){
    overlay=document.createElement('div');
    overlay.id='importModal';
    overlay.className='modal-overlay import-modal';
    overlay.innerHTML=`<div class="modal-panel"><div class="modal-header"><h2>ğŸ“¤ åŒ¯å…¥è¡Œç¨‹ JSON</h2><button class="modal-close" onclick="closeImportModal()">âœ•</button></div><p style="font-size:13px;color:var(--text2);margin-bottom:10px">è²¼ä¸Šè¡Œç¨‹ JSONï¼Œå°‡è¦†è“‹ã€Œ<span id="importPlanName"></span>ã€çš„å…§å®¹</p><textarea id="importTextarea" placeholder='è²¼ä¸Š JSON...'></textarea><div class="import-actions"><button class="btn-cancel" onclick="closeImportModal()">å–æ¶ˆ</button><button class="btn-import" onclick="doImport()">åŒ¯å…¥ä¸¦å¥—ç”¨</button></div></div>`;
    overlay.addEventListener('click',e=>{if(e.target===overlay)closeImportModal()});
    document.body.appendChild(overlay);
  }
  document.getElementById('importPlanName').textContent=getActivePlan().name;
  document.getElementById('importTextarea').value='';
  overlay.classList.add('open');
}
function closeImportModal(){const o=document.getElementById('importModal');if(o)o.classList.remove('open')}
function doImport(){
  const raw=document.getElementById('importTextarea').value.trim();
  if(!raw){alert('è«‹è²¼ä¸Š JSON');return}
  try{
    const data=JSON.parse(raw);
    if(typeof data!=='object'||Array.isArray(data)){throw new Error('æ ¼å¼éŒ¯èª¤')}
    // Validate: should have date keys with arrays
    const keys=Object.keys(data);
    if(!keys.length) throw new Error('ç©ºè³‡æ–™');
    const hasDateKey=keys.some(k=>/^\d{4}-\d{2}-\d{2}$/.test(k));
    if(!hasDateKey) throw new Error('æ‰¾ä¸åˆ°æ—¥æœŸ keyï¼ˆæ ¼å¼ï¼šYYYY-MM-DDï¼‰');
    updateActiveItinerary(data);
    closeImportModal();
    renderItinerary(); renderMap();
    showToastMsg('âœ… è¡Œç¨‹å·²åŒ¯å…¥ä¸¦å¥—ç”¨');
  }catch(e){
    alert('JSON è§£æå¤±æ•—ï¼š'+e.message);
  }
}

// === AI REVIEW ===
function aiReview(){
  let overlay=document.getElementById('aiReviewModal');
  if(!overlay){
    overlay=document.createElement('div');
    overlay.id='aiReviewModal';
    overlay.className='ai-modal-overlay';
    overlay.innerHTML=`<div class="ai-modal"><div class="ai-modal-head"><h2>ğŸ¤– AI è¡Œç¨‹å¯©æŸ¥</h2><button class="modal-close" onclick="closeAiReview()">âœ•</button></div><div class="ai-modal-body" id="aiReviewBody"></div></div>`;
    overlay.addEventListener('click',e=>{if(e.target===overlay)closeAiReview()});
    document.body.appendChild(overlay);
  }
  overlay.classList.add('open');
  const body=document.getElementById('aiReviewBody');
  body.innerHTML=`<div style="padding:4px 0"><textarea id="aiReviewPrompt" rows="3" style="width:100%;padding:10px;border:1px solid #ccc;border-radius:8px;font-size:14px;resize:vertical;font-family:inherit" placeholder="è«‹å¹«æˆ‘å…¨é¢å¯©æŸ¥è¡Œç¨‹ä¸¦çµ¦å»ºè­°ï¼ˆå¯è‡ªè¨‚ï¼Œä¾‹å¦‚ï¼šå¹«æˆ‘æŠŠç¬¬ä¸‰å¤©è¡Œç¨‹æ”¹è¼•é¬†ä¸€é»ï¼‰"></textarea><button onclick="doAiReview()" style="margin-top:8px;padding:10px 24px;background:#1a73e8;color:#fff;border:none;border-radius:8px;font-size:15px;cursor:pointer;font-weight:600">ğŸš€ é–‹å§‹å¯©æŸ¥</button></div>`;
}
function doAiReview(){
  const body=document.getElementById('aiReviewBody');
  const userPrompt=(document.getElementById('aiReviewPrompt').value||'').trim();
  body.innerHTML='<div class="ai-spinner"><div class="spin"></div><div>AI æ­£åœ¨åˆ†æè¡Œç¨‹ï¼Œè«‹ç¨å€™...</div></div>';
  const plan=getActivePlan();
  const itineraryJson=plan.data;
  window._aiSuggestedData=null;
  fetch('/api/review',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({user_prompt:userPrompt,itinerary_json:itineraryJson})})
    .then(r=>r.json()).then(res=>{
      if(res.error){body.innerHTML=`<div style="color:#c62828;padding:20px">âŒ ${res.error}</div>`;return}
      const raw=res.review;
      const marker='<!-- SUGGESTED_JSON -->';
      const idx=raw.indexOf(marker);
      let mdPart=raw, jsonPart=null;
      if(idx!==-1){
        mdPart=raw.substring(0,idx);
        const jsonStr=raw.substring(idx+marker.length).trim();
        try{jsonPart=JSON.parse(jsonStr);window._aiSuggestedData=jsonPart}catch(e){console.warn('AI JSON parse failed',e)}
      }
      let html=simpleMarkdown(mdPart);
      if(window._aiSuggestedData){
        html+=`<div style="text-align:center;margin:20px 0"><button onclick="applyAiSuggestion()" style="padding:12px 32px;background:#2e7d32;color:#fff;border:none;border-radius:8px;font-size:16px;cursor:pointer;font-weight:600">âœ… å¥—ç”¨ AI å»ºè­°</button></div>`;
      }
      body.innerHTML=html;
    }).catch(e=>{body.innerHTML=`<div style="color:#c62828;padding:20px">âŒ ç¶²è·¯éŒ¯èª¤ï¼š${e.message}</div>`});
}
function applyAiSuggestion(){
  if(!window._aiSuggestedData)return;
  updateActiveItinerary(window._aiSuggestedData);
  renderItinerary();renderMap();
  showToastMsg('âœ… å·²å¥—ç”¨ AI å»ºè­°');
  closeAiReview();
}
function closeAiReview(){const o=document.getElementById('aiReviewModal');if(o)o.classList.remove('open')}
function simpleMarkdown(md){
  return md
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/^### (.+)$/gm,'<h3>$1</h3>')
    .replace(/^## (.+)$/gm,'<h2>$1</h2>')
    .replace(/^# (.+)$/gm,'<h1>$1</h1>')
    .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
    .replace(/\*(.+?)\*/g,'<em>$1</em>')
    .replace(/^- (.+)$/gm,'<li>$1</li>')
    .replace(/(<li>.*<\/li>)/gs,'<ul>$1</ul>')
    .replace(/<\/ul>\s*<ul>/g,'')
    .replace(/\n{2,}/g,'</p><p>')
    .replace(/^(?!<[hulo])/gm,function(m){return m?'<p>'+m:m})
    .replace(/<p><\/p>/g,'');
}

init();
</script>
</body>
</html>
