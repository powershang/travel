<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="ä½è³€æ—…è¡Œ">
<meta name="theme-color" content="#e91e63">
<title>2026 ä½è³€æ—…è¡Œ</title>
<link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxODAgMTgwIj48cmVjdCB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgcng9IjQwIiBmaWxsPSIjZTkxZTYzIi8+PHRleHQgeD0iOTAiIHk9IjEwNSIgZm9udC1zaXplPSI4MCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0id2hpdGUiPuS9kOizgDwvdGV4dD48dGV4dCB4PSI5MCIgeT0iMTQ1IiBmb250LXNpemU9IjMwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSIjZmZjY2JjIj7ml4XooYwgMjAyNjwvdGV4dD48L3N2Zz4=">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
:root {
  --pink: #e91e63;
  --pink-light: #fce4ec;
  --pink-dark: #c2185b;
  --bg: #f5f5f5;
  --card: #fff;
  --text: #212121;
  --text2: #757575;
  --safe-top: env(safe-area-inset-top, 0px);
  --safe-bottom: env(safe-area-inset-bottom, 0px);
  --tab-h: 56px;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:var(--bg);color:var(--text);overflow:hidden;height:100vh;height:100dvh;position:fixed;width:100%}

.header{background:linear-gradient(135deg,var(--pink),var(--pink-dark));color:#fff;padding:calc(var(--safe-top)+6px) 16px 6px;display:flex;align-items:center;justify-content:space-between;z-index:100;position:relative}
.header h1{font-size:17px;font-weight:600}
.header .subtitle{font-size:11px;opacity:.85}
.day-chips{display:flex;gap:4px;overflow-x:auto;padding:6px 16px 8px;background:linear-gradient(135deg,var(--pink),var(--pink-dark));-webkit-overflow-scrolling:touch}
.day-chip{flex-shrink:0;padding:5px 12px;border-radius:20px;font-size:12px;font-weight:500;background:rgba(255,255,255,.2);color:#fff;border:none;cursor:pointer;white-space:nowrap;transition:.2s}
.day-chip.active{background:#fff;color:var(--pink-dark);font-weight:600}

.tab-bar{position:fixed;bottom:0;left:0;right:0;height:calc(var(--tab-h)+var(--safe-bottom));padding-bottom:var(--safe-bottom);background:#fff;display:flex;border-top:1px solid #e0e0e0;z-index:100}
.tab-item{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;font-size:10px;color:var(--text2);border:none;background:none;cursor:pointer;padding:4px 0;transition:.2s}
.tab-item.active{color:var(--pink)}
.tab-item .icon{font-size:22px}

.content{position:fixed;top:0;left:0;right:0;height:calc(100dvh - var(--tab-h) - var(--safe-bottom));overflow:hidden}
.page{display:none;height:100%}
.page.active{display:flex;flex-direction:column;overflow:hidden}
.page-scroll{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:8px 12px 20px;min-height:0}

/* Left-right layout */
#itinerary-page .itin-body{flex:1;display:flex;flex-direction:row;overflow:hidden}
#cards-panel{width:45%;min-width:180px;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:8px 10px 20px;border-right:1px solid #e0e0e0;background:var(--bg)}
#map-panel{flex:1;position:relative}
#map-container{width:100%;height:100%}

/* Food page left-right layout */
#food-page .food-body{flex:1;display:flex;flex-direction:row;overflow:hidden}
#food-cards-panel{width:45%;min-width:180px;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:8px 10px 20px;border-right:1px solid #e0e0e0;background:var(--bg)}
#food-map-panel{flex:1;position:relative}
#food-map-container{width:100%;height:100%}

/* Portrait phone: stack top=map, bottom=cards */
@media(max-width:540px) and (orientation:portrait){
  #itinerary-page .itin-body{flex-direction:column}
  #cards-panel{width:100%;order:2;flex:1;border-right:none;border-top:2px solid var(--pink-light)}
  #map-panel{order:1;height:35vh;flex:none}
  #food-page .food-body{flex-direction:column}
  #food-cards-panel{width:100%;order:2;flex:1;border-right:none;border-top:2px solid var(--pink-light)}
  #food-map-panel{order:1;height:35vh;flex:none}
}

.now-indicator{background:var(--pink-light);border-left:3px solid var(--pink);padding:7px 10px;margin-bottom:8px;border-radius:8px;font-size:12px;font-weight:500;color:var(--pink-dark)}
.countdown-bar{background:linear-gradient(135deg,#fff3e0,#ffe0b2);padding:7px 10px;border-radius:8px;font-size:12px;display:flex;align-items:center;gap:6px;margin-bottom:8px}

.card{background:var(--card);border-radius:12px;margin-bottom:10px;box-shadow:0 1px 3px rgba(0,0,0,.07);overflow:hidden;transition:box-shadow .25s}
.card.now{box-shadow:0 0 0 2px var(--pink),0 2px 8px rgba(233,30,99,.2)}
.card.highlight{box-shadow:0 0 0 2px #2196f3,0 2px 8px rgba(33,150,243,.3)}
.card-main{display:flex;align-items:center;padding:10px;gap:8px;cursor:pointer}
.card-time{font-size:12px;font-weight:600;color:var(--pink-dark);min-width:40px;text-align:center}
.card-icon{width:34px;height:34px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:17px;flex-shrink:0}
.card-icon.spot{background:#e8f5e9}.card-icon.restaurant{background:#fff3e0}.card-icon.hotel{background:#fce4ec}.card-icon.transport{background:#e3f2fd}.card-icon.snack{background:#fff8e1}.card-icon.airport{background:#eceff1}
.card-info{flex:1;min-width:0}
.card-name{font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.card-sub{font-size:11px;color:var(--text2);margin-top:1px}
.card-arrow{color:#ccc;font-size:14px;flex-shrink:0}
.card-detail{display:none;padding:0 10px 10px;border-top:1px solid #f0f0f0}
.card-detail.open{display:block}
.card-actions{display:flex;gap:6px;padding-top:6px;flex-wrap:wrap}
.btn{display:inline-flex;align-items:center;gap:4px;padding:6px 10px;border-radius:16px;font-size:11px;font-weight:500;border:none;cursor:pointer;text-decoration:none;white-space:nowrap}
.btn-nav{background:#e3f2fd;color:#1565c0}.btn-call{background:#e8f5e9;color:#2e7d32}.btn-link{background:#fff3e0;color:#e65100}
.btn:active{opacity:.7}
.drive-info{display:flex;align-items:center;gap:4px;padding:2px 10px 2px 58px;font-size:10px;color:var(--text2)}
.drive-info::before{content:'';width:1px;height:10px;background:#ddd}
.section-title{font-size:12px;font-weight:600;color:var(--text2);padding:6px 0 4px}

.leaflet-popup-content{font-size:12px;line-height:1.5}
.leaflet-popup-content a.popup-nav-btn,.leaflet-popup-content a.popup-call-btn{color:#fff !important}
.leaflet-popup-content .popup-title{font-weight:600;font-size:13px;margin-bottom:3px}
.popup-nav-btn{display:inline-block;margin-top:5px;padding:5px 10px;background:#4285f4;color:#fff !important;border-radius:6px;text-decoration:none;font-size:11px;font-weight:600}
.popup-call-btn{display:inline-block;margin-top:5px;padding:5px 10px;background:#2e7d32;color:#fff;border-radius:6px;text-decoration:none;font-size:11px}
.marker-num{width:22px;height:22px;line-height:22px;text-align:center;font-size:11px;font-weight:700;border-radius:50%;color:#fff;box-shadow:0 1px 3px rgba(0,0,0,.3)}
.marker-label{white-space:nowrap;padding:3px 8px;border-radius:12px;font-size:11px;font-weight:700;color:#fff;box-shadow:0 1px 4px rgba(0,0,0,.3);line-height:1.3}

.food-card{background:#fff;border-radius:12px;padding:12px;margin-bottom:10px;box-shadow:0 1px 3px rgba(0,0,0,.07)}
.food-card.highlight{box-shadow:0 0 0 2px #2196f3,0 2px 8px rgba(33,150,243,.3)}
.food-card .food-name{font-size:15px;font-weight:600}
.food-card .food-jp{font-size:15px;margin-top:4px;background:#f5f5f5;padding:6px 10px;border-radius:8px;font-weight:500}
.food-card .food-desc{font-size:13px;margin-top:8px;line-height:1.5}
.food-tag{display:inline-block;padding:2px 10px;border-radius:12px;font-size:11px;font-weight:500;margin-top:6px;margin-right:4px}
.food-tag.day{background:var(--pink-light);color:var(--pink-dark)}.food-tag.price{background:#e8f5e9;color:#2e7d32}.food-tag.rating{background:#fff3e0;color:#e65100}

.res-card{background:#fff;border-radius:12px;padding:14px;margin-bottom:10px;box-shadow:0 1px 3px rgba(0,0,0,.07)}
.res-header{display:flex;justify-content:space-between;align-items:flex-start}
.res-name{font-size:15px;font-weight:600}
.res-date{font-size:11px;font-weight:600;color:#fff;background:var(--pink);padding:3px 10px;border-radius:12px;white-space:nowrap}
.res-info{margin-top:8px;font-size:12px;line-height:1.7;color:var(--text2)}
.res-actions{display:flex;gap:6px;margin-top:10px;flex-wrap:wrap}
.res-status{display:inline-flex;align-items:center;gap:4px;padding:5px 10px;border-radius:18px;font-size:11px;font-weight:500;border:1.5px solid #ddd;background:#fff;cursor:pointer;transition:.2s}
.res-status.confirmed{background:#e8f5e9;border-color:#4caf50;color:#2e7d32}
</style>
</head>
<body>
<div class="content">
  <div id="itinerary-page" class="page active">
    <div class="header"><div><h1>2026 ä½è³€æ—…è¡Œ</h1><div class="subtitle">2/26 (å››) ~ 3/3 (äºŒ) ãƒ» 6å¤©5å¤œ</div></div></div>
    <div class="day-chips" id="dayChips"></div>
    <div class="itin-body">
      <div id="cards-panel"></div>
      <div id="map-panel"><div id="map-container"></div></div>
    </div>
  </div>
  <div id="food-page" class="page">
    <div class="header"><div><h1>ç¾é£ŸæŒ‡å—</h1><div class="subtitle">ç•¶åœ°ç‰¹è‰²ç¾é£Ÿ æ—¥æ–‡+ä¸­æ–‡ çµ¦åº—å“¡çœ‹</div></div></div>
    <div class="food-body">
      <div id="food-cards-panel"></div>
      <div id="food-map-panel"><div id="food-map-container"></div></div>
    </div>
  </div>
  <div id="res-page" class="page">
    <div class="header"><div><h1>é¤å»³é ç´„</h1><div class="subtitle">6 é–“é¤å»³é ç´„è³‡è¨Š</div></div></div>
    <div class="page-scroll" id="resScroll"></div>
  </div>
</div>
<nav class="tab-bar">
  <button class="tab-item active" data-page="itinerary-page"><span class="icon">ğŸ“…</span>è¡Œç¨‹åœ°åœ–</button>
  <button class="tab-item" data-page="food-page"><span class="icon">ğŸ½</span>ç¾é£Ÿ</button>
  <button class="tab-item" data-page="res-page"><span class="icon">ğŸ“±</span>é ç´„</button>
</nav>

<script>
// === DATA (coordinates verified via Google Maps / Tabelog GeoCoordinates) ===
const TRIP_DATES=['2026-02-26','2026-02-27','2026-02-28','2026-03-01','2026-03-02','2026-03-03'];
const DAY_LABELS=['Day1 ä½è³€å¸‚','Day2 å”æ´¥','Day3 ä¼Šä¸‡é‡Œâ†’å¬‰é‡','Day4 è±ªæ–¯ç™»å ¡','Day5 é¹¿å³¶ãƒ»å¤ªè‰¯','Day6 å›ç¨‹'];
const DAY_SHORT=['D1','D2','D3','D4','D5','D6'];
const DAY_REGIONS=['ä½è³€å¸‚ãƒ»ç¥å´','å”æ´¥å¸‚ãƒ»å‘¼å­','ä¼Šä¸‡é‡Œâ†’æ­¦é›„â†’å¬‰é‡','å¬‰é‡â†’è±ªæ–¯ç™»å ¡','æ­¦é›„â†’é¹¿å³¶â†’å¤ªè‰¯','é¹¿å³¶â†’ä½è³€æ©Ÿå ´'];
const DAY_TIPS={
'2026-02-26':['æ‰€æœ‰æ™šé¤å·²é ç´„ 18:00ï¼Œè‹¥è¡Œç¨‹ææ—©/å»¶å¾Œå¯é›»è©±èª¿æ•´','å¸¶ 3æ­²+1æ­²å°å­© â†’ æ¯å¤©ä¸‹åˆé ç•™ 30åˆ†~1hr å½ˆæ€§æ™‚é–“ï¼Œä»¥é˜²å°å­©éœ€è¦ä¼‘æ¯'],
'2026-02-27':['åˆé¤ â†’ ã‹ã‚‰ã¤ãƒãƒ¼ã‚¬ãƒ¼ï¼ˆå”æ´¥æ¼¢å ¡ï¼‰12:10 åœ¨è™¹ã®æ¾åŸåƒï¼Œæ™‚é–“å‰›å¥½ï¼','æ‰€æœ‰æ™šé¤å·²é ç´„ 18:00ï¼Œè‹¥è¡Œç¨‹ææ—©/å»¶å¾Œå¯é›»è©±èª¿æ•´','å¸¶ 3æ­²+1æ­²å°å­© â†’ æ¯å¤©ä¸‹åˆé ç•™ 30åˆ†~1hr å½ˆæ€§æ™‚é–“ï¼Œä»¥é˜²å°å­©éœ€è¦ä¼‘æ¯'],
'2026-02-28':['åˆé¤ â†’ ä¼Šä¸‡é‡Œå¸‚å€è‡ªç”±è¦“é£Ÿï¼ˆæ¨è–¦ï¼šä¼Šä¸‡é‡Œç‰›å®šé£Ÿ or æ‹‰éºµï¼‰~12:00','æ‰€æœ‰æ™šé¤å·²é ç´„ 18:00ï¼Œè‹¥è¡Œç¨‹ææ—©/å»¶å¾Œå¯é›»è©±èª¿æ•´','å¸¶ 3æ­²+1æ­²å°å­© â†’ æ¯å¤©ä¸‹åˆé ç•™ 30åˆ†~1hr å½ˆæ€§æ™‚é–“ï¼Œä»¥é˜²å°å­©éœ€è¦ä¼‘æ¯'],
'2026-03-01':['åˆé¤ â†’ è±ªæ–¯ç™»å ¡åœ’å€å…§è§£æ±ºï¼ˆåœ’å…§å¤šé–“é¤å»³ï¼‰~12:00','æ‰€æœ‰æ™šé¤å·²é ç´„ 18:00ï¼Œè‹¥è¡Œç¨‹ææ—©/å»¶å¾Œå¯é›»è©±èª¿æ•´','å¸¶ 3æ­²+1æ­²å°å­© â†’ æ¯å¤©ä¸‹åˆé ç•™ 30åˆ†~1hr å½ˆæ€§æ™‚é–“ï¼Œä»¥é˜²å°å­©éœ€è¦ä¼‘æ¯'],
'2026-03-02':['å¤§é­šç¥ç¤¾ â†’ é€€æ½®æ™‚æµ·ä¸­é³¥å±…æœ€ç¾ï¼Œå»ºè­°æŸ¥ç•¶å¤©æ½®æ±è¡¨èª¿æ•´æ™‚é–“','æ‰€æœ‰æ™šé¤å·²é ç´„ 18:00ï¼Œè‹¥è¡Œç¨‹ææ—©/å»¶å¾Œå¯é›»è©±èª¿æ•´','å¸¶ 3æ­²+1æ­²å°å­© â†’ æ¯å¤©ä¸‹åˆé ç•™ 30åˆ†~1hr å½ˆæ€§æ™‚é–“ï¼Œä»¥é˜²å°å­©éœ€è¦ä¼‘æ¯'],
'2026-03-03':[]
};

const itinerary={
'2026-02-26':[
  {time:'11:15',name:'æŠµé”ä½è³€æ©Ÿå ´',type:'airport',icon:'âœˆï¸',coords:[33.14972,130.30222],duration:'',note:'IT246 èˆªç­æŠµé”'},
  {time:'12:15',name:'åˆé¤ï¼ˆè‡ªç”±é¸æ“‡ï¼‰',type:'restaurant',icon:'ğŸ½',coords:[33.26159,130.30333],duration:'60åˆ†',note:'ä½è³€å¸‚å€åˆé¤'},
  {time:'13:10',name:'ç¥é‡å…¬åœ’å…’ç«¥éŠæˆ²å ´',type:'spot',icon:'ğŸ ',coords:[33.26511,130.28172],duration:'90åˆ†',note:'å…’ç«¥éŠæ¨‚å ´ï¼Œé©åˆ3æ­²å°å­©',drive:'è»Šç¨‹ç´„25åˆ†'},
  {time:'15:05',name:'å‰é‡ãƒ¶é‡Œæ­´å²å…¬åœ’',type:'spot',icon:'ğŸ¯',coords:[33.32394,130.38876],duration:'90åˆ†',note:'å¼¥ç”Ÿæ™‚ä»£éºè·¡å…¬åœ’ï¼Œå¯çœ‹å¤ä»£ä½å±…å¾©åŸ',drive:'è»Šç¨‹ç´„25åˆ†'},
  {time:'18:00',name:'ä½è³€ç‰›ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³å­£æ¥½ æœ¬åº—',type:'restaurant',icon:'ğŸ¥©',coords:[33.26159,130.30333],duration:'90åˆ†',note:'å·²é ç´„ 18:00ãƒ»ä½è³€ç‰›éµæ¿ç‡’/æ¶®æ¶®é‹\nÂ¥8,000~Â¥14,999\nTabelog 3.54 (446è©•)\nç™¾ååº—2024',phone:'0952-28-4132',tabelog:'https://tabelog.com/saga/A4101/A410101/41000012/',drive:'è»Šç¨‹ç´„30åˆ†'},
  {time:'20:00',name:'airbnb è‹¥å®®ã€‚è–°é¢¨',type:'hotel',icon:'ğŸ¨',coords:[33.2631,130.2980],duration:'',note:'å…¥ä½ä½è³€å¸‚å€æ°‘å®¿',drive:'è»Šç¨‹ç´„5åˆ†'}
],
'2026-02-27':[
  {time:'09:30',name:'å‡ºç™¼',type:'transport',icon:'ğŸš—',coords:[33.2631,130.2980],duration:''},
  {time:'10:05',name:'é¡ç¥ç¤¾ è³æ¢…èŠ±',type:'spot',icon:'ğŸŒ¸',coords:[33.43182,130.00841],duration:'40åˆ†',note:'æ¢…èŠ±å­£ç¯€ï¼ˆ2-3æœˆï¼‰è³æ¢…åæ‰€',drive:'è»Šç¨‹ç´„35åˆ†'},
  {time:'11:00',name:'å”æ´¥åŸ',type:'spot',icon:'ğŸ¯',coords:[33.45351,129.97819],duration:'60åˆ†',note:'åˆ¥åã€Œèˆé¶´åŸã€ï¼Œå¤©å®ˆé–£å¯çœºæœ›å”æ´¥ç£',drive:'è»Šç¨‹ç´„15åˆ†'},
  {time:'12:10',name:'ã‹ã‚‰ã¤ãƒãƒ¼ã‚¬ãƒ¼ï¼ˆè™¹ã®æ¾åŸï¼‰',type:'snack',icon:'ğŸ”',coords:[33.44427,129.99984],duration:'30åˆ†',note:'å”æ´¥æ¼¢å ¡ãƒ»è™¹ã®æ¾åŸåç‰©\nè·¯é‚Šæ”¤è»Šãƒ»~Â¥500',phone:'0955-56-7119',drive:'è»Šç¨‹ç´„5åˆ†'},
  {time:'13:05',name:'å‘¼å­å°åƒï¼šã„ã‹ã—ã‚…ã†ã¾ã„ï¼‹é­šãƒ­ãƒƒã‚±',type:'snack',icon:'ğŸ¦‘',coords:[33.53709,129.89473],duration:'30åˆ†',note:'çƒè³Šç‡’è³£ï¼ˆè¬åŠ ç™ºç¥¥åº—ï¼‰~Â¥500\né­šè‚‰å¯æ¨‚é¤… ~Â¥200',drive:'è»Šç¨‹ç´„25åˆ†'},
  {time:'13:45',name:'ä¸ƒãƒ„é‡œ éŠè¦½èˆ¹ï¼ˆãƒãƒªãƒ³ãƒ‘ãƒ«å‘¼å­ï¼‰',type:'spot',icon:'â›µ',coords:[33.53760,129.89330],duration:'90åˆ†',note:'æŸ±çŠ¶ç¯€ç†æ´çªŸéŠèˆ¹é«”é©—\nå¾ãƒãƒªãƒ³ãƒ‘ãƒ«å‘¼å­å‡ºç™¼\nå¤©å€™ä¸ä½³å¯èƒ½åœèˆª',drive:'æ­¥è¡Œå¯é”'},
  {time:'15:15',name:'å‘¼å­å‘¨é‚Šè‡ªç”±æ´»å‹•',type:'spot',icon:'ğŸš¶',coords:[33.53709,129.89473],duration:'105åˆ†',note:'å‘¼å­æœå¸‚é€šæ•£æ­¥ã€æµ·é‚Šæ•£æ­¥',drive:''},
  {time:'18:00',name:'ã„ã‹ã®æ´»é€ ã‚Š å¤§å’Œ',type:'restaurant',icon:'ğŸ¦‘',coords:[33.52847,129.87946],duration:'90åˆ†',note:'å·²é ç´„ 18:00ãƒ»æ´»çƒè³Šé€ ã‚Š\nã‚¤ã‚«ã®æ´»ãé€ ã‚Šå®šé£Ÿï¼ˆä¸€é­šå…©åƒï¼‰\nå…ˆåˆºèº«ã€å†å¤©å©¦ç¾…\nÂ¥3,000~Â¥3,999ãƒ»Tabelog 3.72',phone:'0955-82-3643',tabelog:'https://tabelog.com/saga/A4102/A410201/41000157/',drive:'è»Šç¨‹ç´„5åˆ†'},
  {time:'20:00',name:'Riverside Hotel å”æ´¥åŸ',type:'hotel',icon:'ğŸ¨',coords:[33.45034,129.98216],duration:'',note:'å”æ´¥å¸‚å€é£¯åº—',drive:'è»Šç¨‹ç´„30åˆ†'}
],
'2026-02-28':[
  {time:'09:30',name:'å‡ºç™¼',type:'transport',icon:'ğŸš—',coords:[33.45034,129.98216],duration:''},
  {time:'10:00',name:'æ¿±é‡æµ¦æ¢¯ç”°å±•æœ›å°',type:'spot',icon:'ğŸŒ¾',coords:[33.48925,129.84735],duration:'30åˆ†',note:'æ—¥æœ¬æ£šç”°ç™¾é¸ä¹‹ä¸€ï¼Œæ‹ç…§æ™¯é»',drive:'è»Šç¨‹ç´„25åˆ†'},
  {time:'11:10',name:'ä¼Šä¸‡é‡Œæ¢…åœ’ è—¤ãƒå°¾',type:'spot',icon:'ğŸŒ¸',coords:[33.29203,129.87567],duration:'50åˆ†',note:'ä¼Šè¬é‡Œæ¢…èŠ±åœ’ï¼Œ2-3æœˆç››é–‹',drive:'è»Šç¨‹ç´„40åˆ†'},
  {time:'12:00',name:'ä¼Šä¸‡é‡Œå¸‚å€åˆé¤',type:'restaurant',icon:'ğŸ½',coords:[33.29203,129.87567],duration:'60åˆ†',note:'å¯å˜—è©¦ä¼Šè¬é‡Œç‰›'},
  {time:'13:40',name:'å¾¡èˆ¹å±±æ¨‚åœ’',type:'spot',icon:'â›°ï¸',coords:[33.18230,130.01798],duration:'90åˆ†',note:'åœ‹ç™»éŒ„ç´€å¿µç‰©ãƒ»åº­åœ’\nteamLabå±•è¦½ï¼ˆå¦‚æœ‰é–‹æ”¾ï¼‰',drive:'è»Šç¨‹ç´„40åˆ†'},
  {time:'15:20',name:'ãŸã‘ãŠæ¸©æ³‰ã·ã‚Šã‚“ï¼ˆæ­¦é›„æ¸©æ³‰ç‰©ç”£é¤¨ï¼‰',type:'snack',icon:'ğŸ®',coords:[33.19656,130.03251],duration:'20åˆ†',note:'æ­¦é›„æº«æ³‰å¸ƒä¸ ~Â¥400\nä½è³€ç”œé»é¸èˆ‰2024 å¸ƒä¸é¡ç¬¬1å\nç‡Ÿæ¥­è‡³17:15',drive:'è»Šç¨‹ç´„5åˆ†'},
  {time:'16:00',name:'ã†ã‚Œã—ã®SHUãƒ—ãƒªãƒ³',type:'snack',icon:'ğŸµ',coords:[33.10110,129.99896],duration:'20åˆ†',note:'å¬‰é‡æº«æ³‰å¸ƒä¸ Â¥300~Â¥400\nä½¿ç”¨å¬‰é‡ç¶ èŒ¶è£½ä½œï¼Œç ”ç™¼3å¹´',drive:'è»Šç¨‹ç´„25åˆ†'},
  {time:'18:00',name:'é·¹é®¨ï¼ˆTaka Zushiï¼‰',type:'restaurant',icon:'ğŸ£',coords:[33.09796,129.98412],duration:'90åˆ†',note:'å·²é ç´„ 18:00ãƒ»å£½å¸/æµ·é®®\nåƒ…7åº§ä½ï¼ˆå«å€‹å®¤ï¼‰\nå†¬å­£æ™‚ä»¤ï¼šãƒ’ãƒ©ãƒ¡ï¼ˆæ¯”ç›®é­šï¼‰ã€é¯›\nÂ¥5,000~Â¥5,999ãƒ»Tabelog 3.17',phone:'0954-43-3210',tabelog:'https://tabelog.com/saga/A4104/A410401/41002823/',drive:'è»Šç¨‹ç´„5åˆ†'},
  {time:'20:00',name:'Hotel Sakura å¬‰é‡',type:'hotel',icon:'ğŸ¨',coords:[33.09747,129.98513],duration:'',note:'å¬‰é‡æº«æ³‰ä½å®¿ï¼ˆä½2æ™šï¼‰',drive:'è»Šç¨‹ç´„3åˆ†'}
],
'2026-03-01':[
  {time:'09:35',name:'å¬‰é‡æ¸©æ³‰æ¹¯è±†è… æ—©åˆé¤',type:'restaurant',icon:'ğŸ«•',coords:[33.09796,129.98412],duration:'60åˆ†',note:'ä½å˜‰å¹³å·å±‹ or å®—åºµã‚ˆã“é•·\nå¬‰é‡æ¸©æ³‰æ°´å°‡è±†è…æº¶æˆè±†ä¹³èˆ¬\nå…¨æ—¥æœ¬ç¨ç‰¹ãƒ»Â¥1,000~Â¥2,000'},
  {time:'11:00',name:'è±ªæ–¯ç™»å ¡ Huis Ten Bosch',type:'spot',icon:'ğŸ¡',coords:[33.08547,129.78854],duration:'330åˆ†',note:'è·è˜­é¢¨ä¸»é¡Œæ¨‚åœ’\nå…¨å¤©éŠç©',drive:'è»Šç¨‹ç´„50åˆ†'},
  {time:'12:00',name:'åœ’å…§åˆé¤',type:'restaurant',icon:'ğŸ½',coords:[33.08547,129.78854],duration:'60åˆ†',note:'è±ªæ–¯ç™»å ¡åœ’å…§ç”¨é¤'},
  {time:'16:30',name:'é›¢é–‹è±ªæ–¯ç™»å ¡',type:'transport',icon:'ğŸš—',coords:[33.08547,129.78854],duration:''},
  {time:'18:00',name:'PIZZERIA MONTE STELLA',type:'restaurant',icon:'ğŸ•',coords:[33.09752,129.98103],duration:'90åˆ†',note:'å·²é ç´„ 18:00ãƒ»æ‹¿å¡é‡Œçª¯çƒ¤æŠ«è–©\nä¸»å»šèµ´ç¾©å­¸è—\nÂ¥3,000~Â¥3,999ãƒ»Tabelog 3.08\né€£åƒ3å¤©æ—¥æ–™å¾Œæ›å£å‘³',phone:'0954-20-2020',tabelog:'https://tabelog.com/saga/A4104/A410401/41006437/',drive:'è»Šç¨‹ç´„50åˆ†'},
  {time:'20:00',name:'Hotel Sakura å¬‰é‡ï¼ˆç¬¬2æ™šï¼‰',type:'hotel',icon:'ğŸ¨',coords:[33.09747,129.98513],duration:'',note:'å¬‰é‡æº«æ³‰ä½å®¿',drive:'è»Šç¨‹ç´„5åˆ†'}
],
'2026-03-02':[
  {time:'09:30',name:'å‡ºç™¼',type:'transport',icon:'ğŸš—',coords:[33.09747,129.98513],duration:''},
  {time:'09:45',name:'æ­¦é›„ãƒ»å¬‰é‡ ç«¥è©±æ‘',type:'spot',icon:'ğŸ§š',coords:[33.12990,129.97640],duration:'75åˆ†',note:'å…’ç«¥ä¸»é¡ŒéŠæ¨‚åœ’',drive:'è»Šç¨‹ç´„15åˆ†'},
  {time:'12:00',name:'å·ã—ãŸï¼ˆç«¹å´èŸ¹æ–™ç†ï¼‰',type:'restaurant',icon:'ğŸ¦€',coords:[32.99168,130.19091],duration:'90åˆ†',note:'å·²é ç´„ 12:00ï¼ˆåˆé¤ï¼‰\nã‹ã«é‡œé£¯ã‚»ãƒƒãƒˆ Â¥2,500\nã‹ã«å¾¡è†³ Â¥4,400~Â¥6,600\n3æœˆ=æ¯èŸ¹æœ‰å…§å­ï¼ˆèŸ¹åµï¼‰\næœ‰æ´»èŸ¹æ°´æ—ç®±ã€å…’ç«¥é¤',phone:'0954-68-2645',drive:'è»Šç¨‹ç´„40åˆ†'},
  {time:'13:40',name:'å¤§é­šç¥ç¤¾ æµ·ä¸­é³¥å±…',type:'spot',icon:'â›©ï¸',coords:[33.03123,130.17775],duration:'30åˆ†',note:'æœ‰æ˜æµ·ä¸­çš„æœ±ç´…é³¥å±…\né€€æ½®æ™‚å¯æ­¥è¡Œé è¿‘',drive:'è»Šç¨‹ç´„15åˆ†'},
  {time:'14:25',name:'ç«¹å´æµ·ç”£ï¼ˆç‚­çƒ¤ç‰¡è £å°å±‹ï¼‰',type:'snack',icon:'ğŸ¦ª',coords:[33.03917,130.17136],duration:'60åˆ†',note:'ç‚­çƒ¤ç«¹å´ç‰¡è £ Â¥2,000~Â¥2,999\n2æœˆ=ç‰¡è £æœ€è‚¥ç¾\nå¹³æ—¥ç‡Ÿæ¥­è‡³16:30',phone:'0954-67-0603',drive:'è»Šç¨‹ç´„5åˆ†'},
  {time:'18:00',name:'å¯¿ã—æ”¿ï¼ˆSushi Masaï¼‰',type:'restaurant',icon:'ğŸ£',coords:[33.08103,130.10901],duration:'90åˆ†',note:'å·²é ç´„ 18:00ãƒ»æœ‰æ˜æµ·å£½å¸\nÂ¥2,000~Â¥2,999ãƒ»Tabelog 3.36\né€±ä¸€ç‡Ÿæ¥­ï¼ˆé‡è¦ï¼é€±å››ä¼‘ï¼‰\nå€‹å®¤å¯ã€å¬°å…’è»Šå¯',phone:'0954-62-5617',tabelog:'https://tabelog.com/saga/A4104/A410402/41001116/',drive:'è»Šç¨‹ç´„25åˆ†'},
  {time:'20:00',name:'airbnb é¹¿å³¶',type:'hotel',icon:'ğŸ¨',coords:[33.1030,130.1020],duration:'',note:'é¹¿å³¶å¸‚æ°‘å®¿',drive:'è»Šç¨‹ç´„10åˆ†'}
],
'2026-03-03':[
  {time:'09:00',name:'å‡ºç™¼å‰å¾€æ©Ÿå ´ï¼ˆææ—©å‡ºé–€ï¼ï¼‰',type:'transport',icon:'ğŸš—',coords:[33.1030,130.1020],duration:''},
  {time:'09:40',name:'æŠµé”ä½è³€æ©Ÿå ´',type:'airport',icon:'âœˆï¸',coords:[33.14972,130.30222],duration:'',note:'æå‰1.5å°æ™‚åˆ°æ©Ÿå ´',drive:'è»Šç¨‹ç´„40åˆ†'},
  {time:'11:25',name:'IT247 èµ·é£›',type:'airport',icon:'ğŸ›«',coords:[33.14972,130.30222],duration:'',note:'ä½è³€â†’æ¡ƒåœ’'},
  {time:'13:05',name:'æŠµé”æ¡ƒåœ’æ©Ÿå ´',type:'airport',icon:'ğŸ ',coords:[25.0797,121.2342],duration:'',note:'åˆ°å®¶ï¼è¾›è‹¦äº†ï½'}
]};

const foods=[
  {name:'ä½è³€ç‰›éµæ¿ç‡’',jp:'ä½è³€ç‰›ã‚¹ãƒ†ãƒ¼ã‚­',day:'Day1',where:'å­£æ¥½ æœ¬åº—',price:'Â¥8,000~Â¥14,999',rating:'5/5',desc:'æ—¥æœ¬é ‚ç´šå’Œç‰›ä¹‹ä¸€ï¼ŒA5ç­‰ç´šä½è³€ç‰›ã€‚éµæ¿ç¾ç…æˆ–æ¶®æ¶®é‹ã€‚æ²¹èŠ±å…¥å£å³åŒ–ã€‚',coords:[33.26159,130.30333],gmap:'ä½è³€ç‰›ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³å­£æ¥½ æœ¬åº—'},
  {name:'æ´»çƒè³Šé€ ã‚Šï¼ˆä¸€é­šå…©åƒï¼‰',jp:'ã‚¤ã‚«ã®æ´»ãé€ ã‚Šå®šé£Ÿ',day:'Day2',where:'å¤§å’Œï¼ˆå‘¼å­ï¼‰',price:'Â¥3,000~Â¥3,999',rating:'5/5',desc:'å‘¼å­åç‰©ï¼é€æ˜æ´»çƒè³Šç¾åˆ‡åˆºèº«ï¼Œé°­å†ç‚¸å¤©å©¦ç¾…ã€‚2-3æœˆç‚ºãƒ¤ãƒªã‚¤ã‚«ï¼ˆæ§çƒè³Šï¼‰æ—ºå­£ã€‚',coords:[33.52847,129.87946],gmap:'ã„ã‹ã®æ´»é€ ã‚Š å¤§å’Œ å‘¼å­'},
  {name:'å”æ´¥æ¼¢å ¡',jp:'ã‹ã‚‰ã¤ãƒãƒ¼ã‚¬ãƒ¼',day:'Day2',where:'è™¹ã®æ¾åŸè·¯é‚Šæ”¤',price:'~Â¥500',rating:'5/5',desc:'è™¹ã®æ¾åŸåç‰©ï¼Œè·¯é‚Šæ”¤è»Šè²©å”®çš„ç¶“å…¸æ¼¢å ¡ã€‚',coords:[33.44427,129.99984],gmap:'ã‹ã‚‰ã¤ãƒãƒ¼ã‚¬ãƒ¼ è™¹ã®æ¾åŸ'},
  {name:'çƒè³Šç‡’è³£',jp:'ã„ã‹ã—ã‚…ã†ã¾ã„',day:'Day2',where:'è¬åŠ å‘¼å­æœå¸‚é€šã‚Šåº—',price:'~Â¥500',rating:'5/5',desc:'å‘¼å­ç™¼ç¥¥ï¼çƒè³Šè‚‰è£½æˆçš„ç‡’è³£ï¼Œå¤–é…¥å…§å½ˆã€‚',coords:[33.53709,129.89473],gmap:'è¬åŠ å‘¼å­æœå¸‚é€šã‚Šåº—'},
  {name:'é­šè‚‰å¯æ¨‚é¤…',jp:'é­šãƒ­ãƒƒã‚±',day:'Day2',where:'å‘¼å­è¡—é‚Šå°æ”¤',price:'~Â¥200',rating:'4/5',desc:'é­šæ¼¿è£½æˆçš„å¯æ¨‚é¤…ï¼Œç‚¸å¾—é‡‘é»ƒé…¥è„†ã€‚',coords:[33.53709,129.89473],gmap:'é­šãƒ­ãƒƒã‚± å‘¼å­'},
  {name:'æ­¦é›„æº«æ³‰å¸ƒä¸',jp:'ãŸã‘ãŠæ¸©æ³‰ã·ã‚Šã‚“',day:'Day3',where:'æ­¦é›„æ¸©æ³‰ç‰©ç”£é¤¨',price:'~Â¥400',rating:'5/5',desc:'ä½è³€ç”œé»é¸èˆ‰2024å¸ƒä¸é¡ç¬¬1åï¼æ»‘é †æ¿ƒéƒã€‚',coords:[33.19656,130.03251],gmap:'æ­¦é›„æ¸©æ³‰ç‰©ç”£é¤¨'},
  {name:'å¬‰é‡ç¶ èŒ¶å¸ƒä¸',jp:'ã†ã‚Œã—ã®SHUãƒ—ãƒªãƒ³',day:'Day3',where:'å¬‰é‡æº«æ³‰è¡—',price:'Â¥300~Â¥400',rating:'4/5',desc:'ä½¿ç”¨å¬‰é‡ç¶ èŒ¶è£½ä½œï¼Œç ”ç™¼3å¹´çš„æŠ¹èŒ¶å¸ƒä¸ã€‚',coords:[33.10110,129.99896],gmap:'ã†ã‚Œã—ã®SHUãƒ—ãƒªãƒ³ å¬‰é‡'},
  {name:'å¬‰é‡æº«æ³‰æ¹¯è±†è…',jp:'å¬‰é‡æ¸©æ³‰æ¹¯ã©ã†ãµ',day:'Day4',where:'ä½å˜‰å¹³å·å±‹ / å®—åºµã‚ˆã“é•·',price:'Â¥1,000~Â¥2,000',rating:'5/5',desc:'å…¨æ—¥æœ¬ç¨ç‰¹ï¼å¬‰é‡æº«æ³‰æ°´å°‡è±†è…æº¶æˆçµ²æ»‘è±†ä¹³ç‹€ã€‚å£æ„Ÿå¦‚å¥¶æ²¹èˆ¬æ»‘é †ï¼Œæ—©é¤æœ€æ¨ã€‚',coords:[33.09796,129.98412],gmap:'ä½å˜‰å¹³å·å±‹ å¬‰é‡æ¸©æ³‰'},
  {name:'ç«¹å´èŸ¹é‡œé£¯',jp:'ã‹ã«é‡œé£¯ã‚»ãƒƒãƒˆ',day:'Day5',where:'å·ã—ãŸ',price:'Â¥2,500',rating:'5/5',desc:'ç”¨ç«¹å´èŸ¹è‚‰ç¾ç…®çš„é‡œé£¯ã€‚3æœˆ=æ¯èŸ¹å­£ç¯€ï¼Œå…§å­ï¼ˆèŸ¹åµï¼‰ç‰¹åˆ¥è±å¯Œã€‚',coords:[32.99168,130.19091],gmap:'å·ã—ãŸ å¤ªè‰¯'},
  {name:'ç‚­çƒ¤ç«¹å´ç‰¡è £',jp:'ç‚­ç„¼ãç«¹å´ã‚«ã‚­',day:'Day5',where:'ç«¹å´æµ·ç”£',price:'Â¥2,000~Â¥2,999',rating:'5/5',desc:'2æœˆæ˜¯ç‰¡è £æœ€è‚¥ç¾çš„å­£ç¯€ï¼åœ¨ç‰¡è £å°å±‹ç‚­ç«ç¾çƒ¤ï¼Œé®®ç”œå¤šæ±ã€‚',coords:[33.03917,130.17136],gmap:'ç«¹å´æµ·ç”£'},
  {name:'æœ‰æ˜æµ·å£½å¸',jp:'æœ‰æ˜æµ·ã®å¯¿å¸',day:'Day5',where:'å¯¿ã—æ”¿',price:'Â¥2,000~Â¥2,999',rating:'4/5',desc:'ä½¿ç”¨æœ‰æ˜æµ·ç•¶æ—¥æ–°é®®æ¼ç²çš„å£½å¸ï¼Œå‘³é“é®®ç¾ã€‚',coords:[33.08103,130.10901],gmap:'å¯¿ã—æ”¿ é¹¿å³¶'}
];

const reservations=[
  {name:'ä½è³€ç‰›ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³å­£æ¥½ æœ¬åº—',zh:'ä½è³€ç‰›éµæ¿ç‡’é¤å»³ å­£æ¥½',date:'2/26 (å››)',time:'18:00',phone:'0952-28-4132',tabelog:'https://tabelog.com/saga/A4101/A410101/41000012/',cuisine:'ä½è³€ç‰›éµæ¿ç‡’/æ¶®æ¶®é‹',price:'Â¥8,000~Â¥14,999',pax:'2å¤§2å°(3æ­²ã€1æ­²)',note:'ç¦è¸ãƒ»æœ‰å€‹å®¤\nç™¾ååº—2024',coords:[33.26159,130.30333]},
  {name:'ã„ã‹ã®æ´»é€ ã‚Š å¤§å’Œ',zh:'æ´»çƒè³Šé€ ã‚Š å¤§å’Œ',date:'2/27 (äº”)',time:'18:00',phone:'0955-82-3643',tabelog:'https://tabelog.com/saga/A4102/A410201/41000157/',cuisine:'æ´»çƒè³Šåˆºèº«/æµ·é®®',price:'Â¥3,000~Â¥3,999',pax:'2å¤§2å°(3æ­²ã€1æ­²)',note:'ç¦è¸ãƒ»è«‹å…ˆç¢ºèªçƒè³Šä¾›æ‡‰\nï¼ˆå¤©å€™/æ¼ç²å½±éŸ¿ï¼‰',coords:[33.52847,129.87946]},
  {name:'é·¹é®¨ (Taka Zushi)',zh:'é·¹é®¨',date:'2/28 (å…­)',time:'18:00',phone:'0954-43-3210',tabelog:'https://tabelog.com/saga/A4104/A410401/41002823/',cuisine:'å£½å¸/æµ·é®®',price:'Â¥5,000~Â¥5,999',pax:'2å¤§2å°(3æ­²ã€1æ­²)',note:'ç¦è¸ãƒ»æ¦»æ¦»ç±³å€‹å®¤4äºº\nåƒ…7åº§ä½ãƒ»å‹™å¿…é ç´„\né€±ä¸‰ä¼‘',coords:[33.09796,129.98412]},
  {name:'PIZZERIA MONTE STELLA',zh:'è’™ç‰¹æ–¯ç‰¹æ‹‰çª¯çƒ¤æŠ«è–©',date:'3/1 (æ—¥)',time:'18:00',phone:'0954-20-2020',tabelog:'https://tabelog.com/saga/A4104/A410401/41006437/',cuisine:'æ‹¿å¡é‡Œçª¯çƒ¤æŠ«è–©',price:'Â¥3,000~Â¥3,999',pax:'2å¤§2å°(3æ­²ã€1æ­²)',note:'ç¦è¸ãƒ»å…’ç«¥å¯\nä¸»å»šèµ´ç¾©å­¸è—',coords:[33.09752,129.98103]},
  {name:'å·ã—ãŸ (Kawashita)',zh:'å·ä¸‹ ç«¹å´èŸ¹æ–™ç†',date:'3/2 (ä¸€)',time:'12:00 åˆé¤',phone:'0954-68-2645',tabelog:'',cuisine:'ç«¹å´èŸ¹æ–™ç†',price:'Â¥2,500~Â¥6,600',pax:'2å¤§2å°(3æ­²ã€1æ­²)',note:'ç¦è¸ãƒ»æœ‰å€‹å®¤ï¼ˆ3é–“ï¼‰\næœ‰å…’ç«¥é¤ãƒ»11:00~19:00ç‡Ÿæ¥­',coords:[32.99168,130.19091]},
  {name:'å¯¿ã—æ”¿ (Sushi Masa)',zh:'å£½å¸æ”¿',date:'3/2 (ä¸€)',time:'18:00',phone:'0954-62-5617',tabelog:'https://tabelog.com/saga/A4104/A410402/41001116/',cuisine:'å£½å¸/æœ‰æ˜æµ·æµ·é®®',price:'Â¥2,000~Â¥2,999',pax:'2å¤§2å°(3æ­²ã€1æ­²)',note:'ç¦è¸ãƒ»å€‹å®¤å¯ãƒ»å¬°å…’è»Šå¯\né€±ä¸€ç‡Ÿæ¥­ãƒ»é€±å››ä¼‘',coords:[33.08103,130.10901]}
];

// === STATE ===
let currentDay=0, currentPage='itinerary-page', leafletMap=null, mapMarkers=[], mapLines=[];
let foodMap=null, foodMarkers=[];
let resStatusMap=JSON.parse(localStorage.getItem('resStatus')||'{}');

function gmapNavUrl(lat,lng){return `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&travelmode=driving`}
function gmapSearchUrl(name){return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(name)}`}

// === INIT ===
function init(){
  const today=new Date().toISOString().slice(0,10);
  const idx=TRIP_DATES.indexOf(today);
  if(idx>=0) currentDay=idx;
  renderDayChips(); renderItinerary(); renderFoodPage(); renderReservations(); setupTabs();
  setTimeout(initMap,200);
  updateCountdown(); setInterval(updateCountdown,60000);
}

// === DAY CHIPS ===
function renderDayChips(){
  const el=document.getElementById('dayChips');
  let html=`<button class="day-chip${currentDay===-1?' active':''}" data-day="-1">ALL ç¸½è¦½</button>`;
  html+=TRIP_DATES.map((d,i)=>{
    const dt=new Date(d+'T00:00:00+09:00');
    const wd=['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][dt.getDay()];
    return `<button class="day-chip${i===currentDay?' active':''}" data-day="${i}">${DAY_SHORT[i]} ${dt.getMonth()+1}/${dt.getDate()}(${wd})</button>`;
  }).join('');
  el.innerHTML=html;
  el.querySelectorAll('.day-chip').forEach(b=>{
    b.onclick=()=>{
      currentDay=+b.dataset.day;
      document.querySelectorAll('.day-chip').forEach(c=>c.classList.toggle('active',+c.dataset.day===currentDay));
      renderItinerary(); renderMap();
    };
  });
}

// === MAP (Leaflet + Google Maps tiles) ===
function initMap(){
  if(leafletMap) return;
  leafletMap=L.map('map-container',{zoomControl:false}).setView([33.25,130.1],9);
  // Google Maps road tiles
  L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}',{
    maxZoom:20,
    attribution:'&copy; Google Maps'
  }).addTo(leafletMap);
  L.control.zoom({position:'bottomright'}).addTo(leafletMap);
  renderMap();
}

function renderMap(){
  if(!leafletMap) return;
  mapMarkers.forEach(m=>leafletMap.removeLayer(m));
  mapLines.forEach(l=>leafletMap.removeLayer(l));
  mapMarkers=[];mapLines=[];
  if(currentDay===-1){ renderOverallMap(); return; }
  const date=TRIP_DATES[currentDay], allItems=itinerary[date]||[];
  const items=allItems.filter(i=>i.coords&&i.coords[0]>30);
  if(!items.length) return;
  const colors={spot:'#4caf50',restaurant:'#ff9800',hotel:'#e91e63',snack:'#ffc107',airport:'#607d8b',transport:'#2196f3'};
  const bounds=[];
  items.forEach((item,idx)=>{
    const origIdx=allItems.indexOf(item);
    const color=colors[item.type]||'#999';
    const labelIcon=L.divIcon({html:`<div class="marker-label" style="background:${color}">${idx+1}. ${item.icon} ${item.name}</div>`,iconSize:[null,null],iconAnchor:[12,14],className:''});
    const marker=L.marker([item.coords[0],item.coords[1]],{icon:labelIcon}).addTo(leafletMap);
    let ph=`<div class="popup-title">${item.icon} ${item.name}</div>`;
    ph+=`<div>${item.time}${item.duration?' ãƒ» '+item.duration:''}</div>`;
    if(item.note) ph+=`<div style="margin-top:3px;font-size:11px;color:#666;white-space:pre-line">${item.note.split('\n').slice(0,2).join('\n')}</div>`;
    ph+=`<a class="popup-nav-btn" href="${gmapSearchUrl(item.name)}" target="_blank">ğŸ“ Google Maps</a>`;
    if(item.phone) ph+=` <a class="popup-call-btn" href="tel:${item.phone}">ğŸ“ æ’¥æ‰“</a>`;
    marker.bindPopup(ph,{maxWidth:260});
    marker.on('click',()=>highlightCard(origIdx));
    mapMarkers.push(marker);
    bounds.push([item.coords[0],item.coords[1]]);
  });
  if(bounds.length>1){
    const line=L.polyline(bounds,{color:'#e91e63',weight:2.5,opacity:.4,dashArray:'6 4'}).addTo(leafletMap);
    mapLines.push(line);
  }
  leafletMap.fitBounds(bounds,{padding:[30,30]});
}

function renderOverallMap(){
  const dayColors=['#e91e63','#ff9800','#4caf50','#2196f3','#9c27b0','#607d8b'];
  const allBounds=[];
  TRIP_DATES.forEach((date,di)=>{
    const items=(itinerary[date]||[]).filter(i=>i.coords&&i.coords[0]>30);
    if(!items.length) return;
    const color=dayColors[di]||'#999';
    const routeCoords=[];
    items.forEach(item=>{
      const labelIcon=L.divIcon({html:`<div class="marker-label" style="background:${color}">${DAY_SHORT[di]} ${item.icon} ${item.name}</div>`,iconSize:[null,null],iconAnchor:[12,14],className:''});
      const marker=L.marker([item.coords[0],item.coords[1]],{icon:labelIcon}).addTo(leafletMap);
      let ph=`<div class="popup-title">${item.icon} ${item.name}</div>`;
      ph+=`<div>${DAY_SHORT[di]} ${item.time}${item.duration?' ãƒ» '+item.duration:''}</div>`;
      ph+=`<a class="popup-nav-btn" href="${gmapSearchUrl(item.name)}" target="_blank">ğŸ“ Google Maps</a>`;
      marker.bindPopup(ph,{maxWidth:260});
      mapMarkers.push(marker);
      routeCoords.push([item.coords[0],item.coords[1]]);
      allBounds.push([item.coords[0],item.coords[1]]);
    });
    if(routeCoords.length>1){
      const line=L.polyline(routeCoords,{color:color,weight:3,opacity:.6,dashArray:'6 4'}).addTo(leafletMap);
      mapLines.push(line);
    }
  });
  if(allBounds.length) leafletMap.fitBounds(allBounds,{padding:[30,30]});
}

function highlightCard(idx){
  document.querySelectorAll('.card').forEach(c=>c.classList.remove('highlight'));
  const card=document.getElementById('card-'+idx);
  if(card){
    card.classList.add('highlight');
    card.scrollIntoView({behavior:'smooth',block:'center'});
    const d=document.getElementById('detail-'+idx);
    if(d&&!d.classList.contains('open')) d.classList.add('open');
    setTimeout(()=>card.classList.remove('highlight'),3000);
  }
}
function focusMap(lat,lng){
  if(!leafletMap) return;
  leafletMap.setView([lat,lng],14,{animate:true});
  const items=(itinerary[TRIP_DATES[currentDay]]||[]).filter(i=>i.coords&&i.coords[0]>30);
  const mi=items.findIndex(i=>i.coords[0]===lat&&i.coords[1]===lng);
  if(mi>=0&&mapMarkers[mi]) mapMarkers[mi].openPopup();
}

// === ITINERARY CARDS ===
function renderItinerary(){
  const panel=document.getElementById('cards-panel');
  if(currentDay===-1){ renderOverallCards(panel); return; }
  const date=TRIP_DATES[currentDay],items=itinerary[date]||[];
  const now=getNowJST(),isToday=now.dateStr===date;
  let html='';
  if(isToday){
    html+=`<div id="nowIndicator" class="now-indicator" style="display:none"></div>`;
    html+=`<div id="countdownBar" class="countdown-bar" style="display:none"></div>`;
  }
  html+=`<div class="section-title">${DAY_LABELS[currentDay]} â€” ${DAY_REGIONS[currentDay]}</div>`;
  let mapIdx=0;
  items.forEach((item,idx)=>{
    const hasMap=item.coords&&item.coords[0]>30;
    if(hasMap) mapIdx++;
    const isNow=isToday&&isCurrentItem(items,idx,now.timeMin);
    html+=item.drive?`<div class="drive-info">ğŸš— ${item.drive}</div>`:'';
    html+=`<div class="card${isNow?' now':''}" id="card-${idx}"><div class="card-main" onclick="onCardClick(${idx})">`;
    html+=`<div class="card-time">${item.time}</div><div class="card-icon ${item.type}">${item.icon}</div>`;
    const numTag=hasMap?`<span style="color:var(--text2);font-size:11px;margin-right:4px">${mapIdx}.</span>`:'';
    html+=`<div class="card-info"><div class="card-name">${numTag}${item.name}</div>`;
    html+=`<div class="card-sub">${item.duration?'â±'+item.duration:''}${item.duration&&item.type?' Â· ':''}${getTypeLabel(item.type)}</div></div>`;
    html+=`<div class="card-arrow">â€º</div></div>`;
    if(item.note||item.phone||item.tabelog||item.coords){
      html+=`<div class="card-detail" id="detail-${idx}">`;
      if(item.note) html+=`<div style="white-space:pre-line;font-size:12px;color:var(--text2);padding:4px 0;line-height:1.6">${item.note}</div>`;
      html+=`<div class="card-actions">`;
      if(item.coords&&item.coords[0]>30) html+=`<a class="btn btn-nav" href="${gmapSearchUrl(item.name)}" target="_blank" onclick="event.stopPropagation()">ğŸ“ Google Maps</a>`;
      if(item.phone) html+=`<a class="btn btn-call" href="tel:${item.phone}" onclick="event.stopPropagation()">ğŸ“ ${item.phone}</a>`;
      if(item.tabelog) html+=`<a class="btn btn-link" href="${item.tabelog}" target="_blank" onclick="event.stopPropagation()">â­ Tabelog</a>`;
      html+=`</div></div>`;
    }
    html+=`</div>`;
  });
  const tips=DAY_TIPS[date]||[];
  if(tips.length){
    html+=`<div style="margin:16px 0 8px;padding:10px 12px;background:var(--card);border-radius:12px;border-left:3px solid #ff9800">`;
    html+=`<div style="font-weight:700;font-size:13px;margin-bottom:6px">âš ï¸ æ³¨æ„äº‹é …</div>`;
    tips.forEach(t=>html+=`<div style="font-size:12px;color:var(--text2);line-height:1.7;padding-left:8px">â€¢ ${t}</div>`);
    html+=`</div>`;
  }
  panel.innerHTML=html;
  if(isToday){updateCountdown();const nc=panel.querySelector('.card.now');if(nc) setTimeout(()=>nc.scrollIntoView({behavior:'smooth',block:'center'}),300);}
}
function renderOverallCards(panel){
  const dayColors=['#e91e63','#ff9800','#4caf50','#2196f3','#9c27b0','#607d8b'];
  let html='<div class="section-title">ğŸ—ºï¸ å…¨è¡Œç¨‹ç¸½è¦½ â€” 6å¤©5å¤œ</div>';
  TRIP_DATES.forEach((date,di)=>{
    const items=(itinerary[date]||[]).filter(i=>i.coords&&i.coords[0]>30&&i.type!=='transport');
    if(!items.length) return;
    const color=dayColors[di];
    html+=`<div style="margin:12px 0 6px;font-weight:700;font-size:13px;color:${color}">${DAY_SHORT[di]} ${DAY_LABELS[di]}</div>`;
    items.forEach(item=>{
      html+=`<div style="display:flex;align-items:center;gap:8px;padding:6px 8px;margin:2px 0;background:var(--card);border-radius:8px;border-left:3px solid ${color};font-size:12px;cursor:pointer" onclick="currentDay=${di};document.querySelectorAll('.day-chip').forEach(c=>c.classList.toggle('active',+c.dataset.day===${di}));renderItinerary();renderMap()">`;
      html+=`<span>${item.icon}</span><span style="flex:1">${item.name}</span><span style="color:var(--text2);font-size:11px">${item.time}</span>`;
      html+=`</div>`;
    });
  });
  panel.innerHTML=html;
}

function onCardClick(idx){
  const d=document.getElementById('detail-'+idx);
  if(d) d.classList.toggle('open');
  const item=(itinerary[TRIP_DATES[currentDay]]||[])[idx];
  if(item&&item.coords&&item.coords[0]>30) focusMap(item.coords[0],item.coords[1]);
}
function getTypeLabel(t){return{spot:'æ™¯é»',restaurant:'é¤å»³',hotel:'ä½å®¿',transport:'äº¤é€š',snack:'å°åƒ',airport:'æ©Ÿå ´'}[t]||''}
function getNowJST(){const n=new Date(),j=new Date(n.getTime()+(n.getTimezoneOffset()+540)*60000);return{dateStr:j.toISOString().slice(0,10),timeMin:j.getHours()*60+j.getMinutes()}}
function parseTime(t){const[h,m]=t.split(':').map(Number);return h*60+m}
function isCurrentItem(items,idx,nowMin){const s=parseTime(items[idx].time),e=idx<items.length-1?parseTime(items[idx+1].time):s+120;return nowMin>=s&&nowMin<e}

// === COUNTDOWN ===
function updateCountdown(){
  const bar=document.getElementById('countdownBar'),ind=document.getElementById('nowIndicator');
  if(!bar||!ind) return;
  const now=getNowJST(),date=TRIP_DATES[currentDay],items=itinerary[date]||[];
  if(now.dateStr!==date){bar.style.display='none';ind.style.display='none';return}
  let ci=-1;for(let i=items.length-1;i>=0;i--)if(now.timeMin>=parseTime(items[i].time)){ci=i;break}
  if(ci>=0){ind.style.display='block';ind.innerHTML=`ğŸ“ ç›®å‰ï¼š${items[ci].name}`}
  if(ci>=0&&ci<items.length-1){const nx=items[ci+1],diff=parseTime(nx.time)-now.timeMin;if(diff>0&&diff<=180){bar.style.display='flex';bar.innerHTML=`â³ ä¸‹ä¸€ç«™ <b>${nx.name}</b>ã€€${diff}åˆ†é˜å¾Œ (${nx.time})`}else bar.style.display='none'}else bar.style.display='none';
}

// === FOOD PAGE ===
function renderFoodPage(){
  const s=document.getElementById('food-cards-panel');
  let h='<div class="section-title">ä½è³€ç‰¹è‰²ç¾é£Ÿ â€” æ—¥æ–‡åå¯ç›´æ¥çµ¦åº—å“¡çœ‹</div>';
  foods.forEach((f,i)=>{
    h+=`<div class="food-card" id="food-card-${i}" onclick="onFoodCardClick(${i})" style="cursor:pointer"><div class="food-name">${f.name}</div><div class="food-jp">ğŸ‡¯ğŸ‡µ ${f.jp}</div>`;
    h+=`<div class="food-desc">${f.desc}</div><div><span class="food-tag day">${f.day}</span><span class="food-tag price">${f.price}</span><span class="food-tag rating">æ¨è–¦ ${f.rating}</span></div>`;
    h+=`<div style="font-size:11px;color:var(--text2);margin-top:4px">ğŸ“ ${f.where}`;
    if(f.coords) h+=` <a class="btn btn-nav" href="${gmapSearchUrl(f.gmap||f.name)}" target="_blank" onclick="event.stopPropagation()" style="margin-left:4px">ğŸ“ Google Maps</a>`;
    h+=`</div></div>`;
  });
  h+='<div class="section-title">ğŸŸ å­£ç¯€æµ·é®®æŒ‡å—</div>';
  h+='<div class="food-card"><div class="food-name">2/27 å”æ´¥ãƒ»å‘¼å­ çƒè³Šå­£</div><div class="food-desc" style="line-height:1.8">ğŸ¦‘ <b>ãƒ¤ãƒªã‚¤ã‚«</b>ï¼ˆæ§çƒè³Šï¼‰â€” 1~3æœˆæ—ºå­£ï¼Œé€æ˜è„†å½ˆ<br>ğŸ¦‘ <b>ã‚¢ã‚ªãƒªã‚¤ã‚«</b>ï¼ˆå†¬çƒè³Šï¼‰â€” 11~3æœˆé™å®šï¼Œåšå¯¦ç”˜ç”œ<br>ğŸ¦‘ <b>ã‚³ã‚¦ã‚¤ã‚«</b>ï¼ˆå¢¨çƒè³Šï¼‰â€” 2~4æœˆï¼Œæœ€ç”œ</div></div>';
  h+='<div class="food-card"><div class="food-name">3/2 å¤ªè‰¯ãƒ»é¹¿å³¶ æœ‰æ˜æµ·</div><div class="food-desc" style="line-height:1.8">ğŸ¦ª <b>ç«¹å´ç‰¡è £</b> â€” 11~3æœˆï¼ˆ2æœˆæœ€è‚¥ï¼‰å¤§é¡†é®®ç”œ<br>ğŸ¦€ <b>ç«¹å´èŸ¹ ãƒ¡ã‚¹ã‚¬ãƒ‹</b>ï¼ˆæ¯èŸ¹ï¼‰â€” 3æœˆæœ‰å…§å­ï¼ˆèŸ¹åµï¼‰<br>ğŸŸ <b>ãƒ ãƒ„ã‚´ãƒ­ã‚¦</b>ï¼ˆå½ˆå¡—é­šï¼‰â€” æœ‰æ˜æµ·ç‰¹ç”¢ï¼Œè’²ç‡’é¢¨å‘³</div></div>';
  s.innerHTML=h;
}

function initFoodMap(){
  if(foodMap) return;
  foodMap=L.map('food-map-container',{zoomControl:false}).setView([33.25,130.1],9);
  L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}',{maxZoom:20,attribution:'&copy; Google Maps'}).addTo(foodMap);
  L.control.zoom({position:'bottomright'}).addTo(foodMap);
  const colors={Day1:'#e91e63',Day2:'#ff9800',Day3:'#4caf50',Day4:'#2196f3',Day5:'#9c27b0'};
  const bounds=[];
  foods.forEach((f,i)=>{
    if(!f.coords) return;
    const color=colors[f.day]||'#999';
    const labelIcon=L.divIcon({html:`<div class="marker-label" style="background:${color}">${i+1}. ğŸ½ ${f.name}</div>`,iconSize:[null,null],iconAnchor:[12,14],className:''});
    const marker=L.marker([f.coords[0],f.coords[1]],{icon:labelIcon}).addTo(foodMap);
    let ph=`<div class="popup-title">ğŸ½ ${f.name}</div>`;
    ph+=`<div>${f.day} ãƒ» ${f.where}</div>`;
    ph+=`<div style="margin-top:3px;font-size:11px;color:#666">${f.jp}</div>`;
    ph+=`<a class="popup-nav-btn" href="${gmapSearchUrl(f.gmap||f.name)}" target="_blank">ğŸ“ Google Maps</a>`;
    marker.bindPopup(ph,{maxWidth:260});
    marker.on('click',()=>highlightFoodCard(i));
    foodMarkers.push(marker);
    bounds.push([f.coords[0],f.coords[1]]);
  });
  if(bounds.length) foodMap.fitBounds(bounds,{padding:[30,30]});
}

function onFoodCardClick(idx){
  const f=foods[idx];
  if(!f||!f.coords||!foodMap) return;
  foodMap.setView([f.coords[0],f.coords[1]],14,{animate:true});
  if(foodMarkers[idx]) foodMarkers[idx].openPopup();
}

function highlightFoodCard(idx){
  document.querySelectorAll('#food-cards-panel .food-card').forEach(c=>c.classList.remove('highlight'));
  const card=document.getElementById('food-card-'+idx);
  if(card){
    card.classList.add('highlight');
    card.scrollIntoView({behavior:'smooth',block:'center'});
    setTimeout(()=>card.classList.remove('highlight'),3000);
  }
}

// === RESERVATIONS ===
function renderReservations(){
  const s=document.getElementById('resScroll');
  let h='<div class="section-title">é ç´„äººï¼šWu Tsung Hsuan ãƒ» +886-981053092</div>';
  reservations.forEach((r,i)=>{
    const cf=resStatusMap[i];
    h+=`<div class="res-card"><div class="res-header"><div><div class="res-name">${r.zh||r.name}</div><div style="font-size:11px;color:var(--text2);margin-top:2px">${r.name}</div></div>`;
    h+=`<div class="res-date">${r.date} ${r.time}</div></div>`;
    h+=`<div class="res-info">ğŸ½ ${r.cuisine}<br>ğŸ’° ${r.price}<br>ğŸ‘¥ ${r.pax}<br>ğŸ“ ${r.note.replace(/\n/g,'<br>')}</div>`;
    h+=`<div class="res-actions"><a class="btn btn-call" href="tel:${r.phone}">ğŸ“ ${r.phone}</a>`;
    if(r.coords) h+=`<a class="btn btn-nav" href="${gmapSearchUrl(r.name)}" target="_blank">ğŸ“ Google Maps</a>`;
    if(r.tabelog) h+=`<a class="btn btn-link" href="${r.tabelog}" target="_blank">â­ Tabelog</a>`;
    h+=`<button class="res-status${cf?' confirmed':''}" onclick="toggleResStatus(${i},this)">${cf?'âœ… å·²ç¢ºèª':'â¬œ å¾…ç¢ºèª'}</button></div></div>`;
  });
  s.innerHTML=h;
}
function toggleResStatus(i,b){resStatusMap[i]=!resStatusMap[i];localStorage.setItem('resStatus',JSON.stringify(resStatusMap));b.classList.toggle('confirmed');b.textContent=resStatusMap[i]?'âœ… å·²ç¢ºèª':'â¬œ å¾…ç¢ºèª'}

// === TABS ===
function setupTabs(){
  document.querySelectorAll('.tab-item').forEach(tab=>{
    tab.onclick=()=>{
      const page=tab.dataset.page;if(page===currentPage) return;
      currentPage=page;
      document.querySelectorAll('.tab-item').forEach(t=>t.classList.toggle('active',t===tab));
      document.querySelectorAll('.page').forEach(p=>p.classList.toggle('active',p.id===page));
      if(page==='itinerary-page'&&leafletMap) setTimeout(()=>{leafletMap.invalidateSize();renderMap()},100);
      if(page==='food-page') setTimeout(()=>{if(!foodMap) initFoodMap(); else foodMap.invalidateSize();},100);
    };
  });
}

// === SERVICE WORKER + MANIFEST ===
if('serviceWorker' in navigator){
  const sw=`const C='saga-v4';const U=['./','https://unpkg.com/leaflet@1.9.4/dist/leaflet.css','https://unpkg.com/leaflet@1.9.4/dist/leaflet.js'];self.addEventListener('install',e=>e.waitUntil(caches.open(C).then(c=>c.addAll(U)).then(()=>self.skipWaiting())));self.addEventListener('activate',e=>e.waitUntil(caches.keys().then(ks=>Promise.all(ks.filter(k=>k!==C).map(k=>caches.delete(k)))).then(()=>self.clients.claim())));self.addEventListener('fetch',e=>e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request).then(res=>{if(res.ok){const c=res.clone();caches.open(C).then(cache=>cache.put(e.request,c));}return res}).catch(()=>new Response('é›¢ç·šä¸­',{headers:{'Content-Type':'text/plain'}})))));`;
  navigator.serviceWorker.register(URL.createObjectURL(new Blob([sw],{type:'application/javascript'}))).catch(()=>{});
}
const mf={name:'2026 ä½è³€æ—…è¡Œ',short_name:'ä½è³€æ—…è¡Œ',start_url:'.',display:'standalone',background_color:'#f5f5f5',theme_color:'#e91e63',icons:[{src:'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxODAgMTgwIj48cmVjdCB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgcng9IjQwIiBmaWxsPSIjZTkxZTYzIi8+PHRleHQgeD0iOTAiIHk9IjEwNSIgZm9udC1zaXplPSI4MCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0id2hpdGUiPuS9kOizgDwvdGV4dD48dGV4dCB4PSI5MCIgeT0iMTQ1IiBmb250LXNpemU9IjMwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSIjZmZjY2JjIj7ml4XooYwgMjAyNjwvdGV4dD48L3N2Zz4=',sizes:'180x180',type:'image/svg+xml'}]};
const ml=document.createElement('link');ml.rel='manifest';ml.href=URL.createObjectURL(new Blob([JSON.stringify(mf)],{type:'application/json'}));document.head.appendChild(ml);

init();
</script>
</body>
</html>
